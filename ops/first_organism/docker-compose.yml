# First Organism Integration Test Infrastructure
# ================================================
#
# Provides isolated PostgreSQL and Redis instances for First Organism
# integration tests with MANDATORY secure, non-default credentials.
#
# SECURITY REQUIREMENTS:
#   - PostgreSQL password: minimum 12 characters, not in banned list
#   - Redis password: minimum 12 characters, required for all connections
#   - Localhost-only binding to prevent external access
#   - SCRAM-SHA-256 authentication for PostgreSQL
#   - Resource limits to prevent runaway processes
#
# Prerequisites:
#   1. Copy template: cp first_organism.env.template ../../.env.first_organism
#   2. Generate secure credentials (see template for commands)
#   3. Replace all <REPLACE_...> placeholders
#
# Usage:
#   # Start infrastructure
#   docker compose -f ops/first_organism/docker-compose.yml --env-file .env.first_organism up -d
#
#   # Wait for healthy status
#   docker compose -f ops/first_organism/docker-compose.yml ps
#
#   # Run tests (with env loaded)
#   pytest -m first_organism
#
#   # Tear down (removes volumes for clean state)
#   docker compose -f ops/first_organism/docker-compose.yml down -v
#
# Troubleshooting:
#   # Check logs
#   docker compose -f ops/first_organism/docker-compose.yml logs postgres
#   docker compose -f ops/first_organism/docker-compose.yml logs redis
#
#   # Reset to clean state
#   docker compose -f ops/first_organism/docker-compose.yml down -v
#   docker volume rm first_organism_pgdata first_organism_redis 2>/dev/null || true

version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    container_name: first_organism_postgres
    restart: unless-stopped
    env_file:
      - ../../.env.first_organism
    environment:
      POSTGRES_DB: ${POSTGRES_DB:?POSTGRES_DB must be set}
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER must be set}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      # Security hardening
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    ports:
      # Bind only to localhost to prevent external access
      - "127.0.0.1:5432:5432"
    volumes:
      - first_organism_pgdata:/var/lib/postgresql/data
      # Optional: mount init scripts
      # - ./init-scripts:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} -q"
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    # Resource limits for test environment
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    # Security options
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:7-alpine
    container_name: first_organism_redis
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - ../../.env.first_organism
    command: >
      sh -c "redis-server
        --appendonly yes
        --requirepass '${REDIS_PASSWORD:?REDIS_PASSWORD must be set}'
        --maxclients 100
        --bind 0.0.0.0
        --protected-mode yes
        --tcp-backlog 128
        --timeout 300
        --tcp-keepalive 60
        --maxmemory 128mb
        --maxmemory-policy allkeys-lru"
    ports:
      # Port 6380 to avoid conflicts with dev Redis (6379)
      - "127.0.0.1:6380:6379"
    volumes:
      - first_organism_redis:/data
    healthcheck:
      test:
        [
          "CMD",
          "redis-cli",
          "-a",
          "${REDIS_PASSWORD}",
          "--no-auth-warning",
          "ping"
        ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    security_opt:
      - no-new-privileges:true

volumes:
  first_organism_pgdata:
    name: first_organism_pgdata
    # Named volume for persistence between container restarts
    # Use 'down -v' to remove for clean test state
  first_organism_redis:
    name: first_organism_redis

networks:
  default:
    name: first_organism_network
    driver: bridge
    # Internal network isolates services from host network
    ipam:
      config:
        - subnet: 172.28.0.0/16
