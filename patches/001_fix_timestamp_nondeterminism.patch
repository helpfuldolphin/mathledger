From: Manus-A <manus-a@mathledger.ai>
Date: Fri, 6 Dec 2025 00:00:00 +0000
Subject: [PATCH] Fix critical timestamp nondeterminism in canonical artifacts

This patch eliminates all datetime.now()/datetime.utcnow() usage in
canonical artifacts that must be deterministic for hash-law correctness.

Affected files:
- bootstrap_metabolism.py
- rfl_gate.py  
- phase_ix_attestation.py
- backend/metrics_md_report.py

All timestamp generation now uses deterministic_isoformat() from
backend.repro.determinism, which derives timestamps from content hashes
rather than wall-clock time.

Invariant enforced: No wall-clock time in canonical artifacts

---
 bootstrap_metabolism.py              | 5 +++--
 rfl_gate.py                          | 5 +++--
 phase_ix_attestation.py              | 5 +++--
 backend/metrics_md_report.py         | 5 +++--
 4 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/bootstrap_metabolism.py b/bootstrap_metabolism.py
index 1234567..abcdefg 100644
--- a/bootstrap_metabolism.py
+++ b/bootstrap_metabolism.py
@@ -1,6 +1,7 @@
 """Bootstrap metabolism for First Organism."""
 
 from datetime import datetime
+from backend.repro.determinism import deterministic_isoformat
 
 def create_bootstrap_event(seed: int, event_data: dict) -> dict:
     """Create a deterministic bootstrap event."""
@@ -290,7 +291,7 @@ def create_bootstrap_event(seed: int, event_data: dict) -> dict:
     return {
         "event_id": f"bootstrap-{seed}",
         "event_type": "bootstrap",
-        "timestamp": datetime.utcnow().isoformat() + "Z",
+        "timestamp": deterministic_isoformat(seed, event_data),
         "data": event_data,
     }
 
diff --git a/rfl_gate.py b/rfl_gate.py
index 2345678..bcdefgh 100644
--- a/rfl_gate.py
+++ b/rfl_gate.py
@@ -1,6 +1,7 @@
 """RFL curriculum gate evaluation."""
 
 from datetime import datetime
+from backend.repro.determinism import deterministic_isoformat
 
 def evaluate_gate(seed: int, metrics: dict) -> dict:
     """Evaluate curriculum gate with deterministic timestamp."""
@@ -468,7 +469,7 @@ def evaluate_gate(seed: int, metrics: dict) -> dict:
     return {
         "gate_id": f"gate-{seed}",
         "verdict": "PASS" if metrics["coverage"] > 0.95 else "FAIL",
-        "timestamp": datetime.utcnow().isoformat() + "Z",
+        "timestamp": deterministic_isoformat(seed, metrics),
         "metrics": metrics,
     }
 

diff --git a/phase_ix_attestation.py b/phase_ix_attestation.py
index 3456789..cdefghi 100644
--- a/phase_ix_attestation.py
+++ b/phase_ix_attestation.py
@@ -1,6 +1,7 @@
 """Phase IX attestation with dual-root seal."""
 
 from datetime import datetime, timezone
+from backend.repro.determinism import deterministic_isoformat
 
 def create_attestation(seed: int, reasoning_root: str, ui_root: str) -> dict:
     """Create deterministic attestation."""
@@ -219,7 +220,7 @@ def create_attestation(seed: int, reasoning_root: str, ui_root: str) -> dict:
     return {
         "attestation_id": f"attest-{seed}",
         "reasoning_root": reasoning_root,
         "ui_root": ui_root,
-        'timestamp': datetime.now(timezone.utc).isoformat().replace('+00:00', 'Z'),
+        'timestamp': deterministic_isoformat(seed, reasoning_root, ui_root),
         "composite_root": composite_root,
     }
 

diff --git a/backend/metrics_md_report.py b/backend/metrics_md_report.py
index 4567890..defghij 100644
--- a/backend/metrics_md_report.py
+++ b/backend/metrics_md_report.py
@@ -1,6 +1,7 @@
 """Metrics markdown report generation."""
 
 from datetime import datetime
+from backend.repro.determinism import deterministic_timestamp
 
 def generate_report(seed: int, metrics: dict) -> str:
     """Generate deterministic metrics report."""
@@ -252,7 +253,7 @@ def generate_report(seed: int, metrics: dict) -> str:
     # Generate report header with deterministic date
-    date_str = datetime.now().strftime('%Y-%m-%d')
+    date_str = deterministic_timestamp(seed).strftime('%Y-%m-%d')
     
     report = f"""# Metrics Report
     
-- 
2.40.0
