From: Manus-A <manus-a@mathledger.ai>
Date: Fri, 6 Dec 2025 00:00:00 +0000
Subject: [PATCH] Fix JSON serialization nondeterminism

This patch adds sort_keys=True to all json.dumps() calls in canonical
contexts to ensure deterministic dict key ordering.

Python 3.7+ guarantees dict insertion order, but the JSON spec does not
require any particular order. Using sort_keys=True ensures:
1. Cross-version compatibility
2. Cross-implementation compatibility (CPython, PyPy, etc.)
3. Compliance with RFC 8785 canonical JSON principles

Affected files:
- backend/axiom_engine/derive.py
- backend/metrics_cartographer.py
- backend/causal/graph.py

Invariant enforced: Dict key ordering must be deterministic

---
 backend/axiom_engine/derive.py       | 10 +++++-----
 backend/metrics_cartographer.py      |  4 ++--
 backend/causal/graph.py              |  2 +-
 3 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/backend/axiom_engine/derive.py b/backend/axiom_engine/derive.py
index abcdef0..1234567 100644
--- a/backend/axiom_engine/derive.py
+++ b/backend/axiom_engine/derive.py
@@ -218,10 +218,10 @@ def build_lean_job(statement: str, theory: str = "Propositional") -> dict:
             "theory": theory,
             "timeout": 30
         }
-        params += [json.dumps(header)]
+        params += [json.dumps(header, sort_keys=True)]
         
         leafs = {"leaves": [statement]}
-        params += [json.dumps(leafs)]
+        params += [json.dumps(leafs, sort_keys=True)]
         
         return {
             "command": "lean",
@@ -416,7 +416,7 @@ def enqueue_lean_job(redis_client, statement: str) -> bool:
         """Enqueue a Lean verification job."""
         try:
-            job_data = json.dumps({
+            job_data = json.dumps({
                 "text": statement,
                 "theory": "Propositional",
                 "timeout": 30
-            })
+            }, sort_keys=True)
             
             redis_client.rpush("ml:jobs", job_data)
             return True
@@ -555,8 +555,8 @@ def test_derive_with_lean(db_session):
             rc = redis.Redis(host='localhost', port=6379, db=0)
             
             # Enqueue jobs
-            rc.rpush("ml:jobs", json.dumps({"text": p1.formula, "theory": "Propositional"}))
-            rc.rpush("ml:jobs", json.dumps({"text": p2.formula, "theory": "Propositional"}))
+            rc.rpush("ml:jobs", json.dumps({"text": p1.formula, "theory": "Propositional"}, sort_keys=True))
+            rc.rpush("ml:jobs", json.dumps({"text": p2.formula, "theory": "Propositional"}, sort_keys=True))
             
             # Process jobs
             result = derive_with_lean_worker(db_session, rc)

diff --git a/backend/metrics_cartographer.py b/backend/metrics_cartographer.py
index bcdef01..2345678 100644
--- a/backend/metrics_cartographer.py
+++ b/backend/metrics_cartographer.py
@@ -73,7 +73,7 @@ class MetricsSnapshot:
     
     def compute_merkle_hash(self) -> str:
         """Compute SHA-256 hash of the normalized metrics payload."""
-        payload = json.dumps(self.metrics, sort_keys=True, separators=(",", ":"))
+        payload = json.dumps(self.metrics, sort_keys=True, separators=(",", ":"), ensure_ascii=True)
         return hashlib.sha256(payload.encode()).hexdigest()
 
 
@@ -1132,7 +1132,7 @@ class MetricsCartographer:
     
     def _compute_history_merkle(self, history: List[Dict[str, Any]]) -> str:
-        payload = json.dumps(history, sort_keys=True, separators=(",", ":"))
+        payload = json.dumps(history, sort_keys=True, separators=(",", ":"), ensure_ascii=True)
         return hashlib.sha256(payload.encode()).hexdigest()

diff --git a/backend/causal/graph.py b/backend/causal/graph.py
index cdef012..3456789 100644
--- a/backend/causal/graph.py
+++ b/backend/causal/graph.py
@@ -237,7 +237,7 @@ class CausalGraph:
     
     def hash(self) -> str:
         """Compute deterministic hash of graph structure."""
-        data = json.dumps(self.to_dict(), sort_keys=True)
+        data = json.dumps(self.to_dict(), sort_keys=True, ensure_ascii=True)
         return hashlib.sha256(data.encode()).hexdigest()
 
-- 
2.40.0
