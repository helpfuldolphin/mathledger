# Branch Protection Configuration

## Overview

This document describes how to enable the Epoch Seal as a required check in GitHub branch protection rules.

## Required Check: Epoch Seal

The Epoch Seal is a cryptographic binding of all verification lanes that must pass before merging to protected branches.

### Enabling Branch Protection

1. Navigate to repository Settings â†’ Branches
2. Add or edit branch protection rule for `main` or `integrate/ledger-v0.1`
3. Enable "Require status checks to pass before merging"
4. Search for and select: **"Epoch Seal"**
5. Enable "Require branches to be up to date before merging" (recommended)
6. Save changes

### Required Status Check Name

The CI workflow must report status with the exact name:

```
Epoch Seal
```

This status check is generated by the AllBlue Gate verification system when running:

```bash
python3 scripts/generate_allblue_epoch_seal.py
```

### Pass Criteria

The Epoch Seal check passes when:

1. All required lanes have verified artifacts
2. Witnessed epoch includes signatures from:
   - Verification Gate (triple_hash lane)
   - Hermetic Matrix (dual_attestation lane)
3. RFC 8785 canonicalization is maintained
4. Fleet state is frozen and archived

### Pass-Lines Output

When the check passes, CI will output:

```
[PASS] Epoch Seal <64-hex-sha256>
[PASS] Witnessed Epoch <64-hex-sha256>
```

### ABSTAIN Behavior

If required artifacts are missing, the check will ABSTAIN (exit code 1) with:

```
[ABSTAIN] AllBlue Gate: N required lane(s) missing artifacts
[INFO] Epoch Seal <64-hex-sha256>
[INFO] Witnessed Epoch <64-hex-sha256>
```

This prevents merging incomplete verification states while maintaining Proof-or-Abstain integrity.

## Witnessed Epoch

The Witnessed Epoch extends the base Epoch Seal with dual signatures from independent lanes:

### Witness Signatures

1. **Verification Gate** (`verification_gate_sig`)
   - Source: triple_hash lane (U_t, R_t, H_t verification)
   - Signature: `sha256("verification_gate:{lane_hash}:{H_t}")`

2. **Hermetic Matrix** (`hermetic_matrix_sig`)
   - Source: dual_attestation lane (UI + Reasoning composite)
   - Signature: `sha256("hermetic_matrix:{lane_hash}")`

### Witnessed Seal Computation

```
witnessed_epoch_hash = sha256(RFC8785({
  epoch_core: {
    lanes: {lane_id: hash},
    H_t: hash,
    hygiene_state_hash: hash,
    verification_signature: timestamp
  },
  witnesses: {
    verification_gate_sig: hash,
    hermetic_matrix_sig: hash
  }
}))
```

### Fleet State Structure

The frozen fleet state includes:

```json
{
  "allblue_status": "PASS",
  "epoch_hash": "<base-epoch-seal>",
  "witnessed_epoch_hash": "<witnessed-epoch-seal>",
  "witnesses": {
    "verification_gate_sig": "<64-hex>",
    "hermetic_matrix_sig": "<64-hex>"
  },
  "witnessed_epoch": {
    "algorithm": "sha256",
    "canonicalization": "RFC8785",
    "components": ["epoch_core", "witnesses"],
    "hash": "<witnessed-epoch-seal>"
  }
}
```

## Verification

To verify branch protection is enabled:

1. Attempt to merge a PR without passing Epoch Seal
2. GitHub should block the merge with: "Required status check 'Epoch Seal' is expected"
3. Once the check passes, merge should be allowed

## Acceptance Criteria

- [ ] Branch protection rule created for target branch
- [ ] "Epoch Seal" added as required status check
- [ ] CI workflow reports status with exact name "Epoch Seal"
- [ ] Fleet state contains witnessed_epoch block with signatures
- [ ] Pass-lines print both epoch seal and witnessed epoch hashes
- [ ] ABSTAIN behavior prevents merge when artifacts missing

## References

- AllBlue Gate: `scripts/generate_allblue_epoch_seal.py`
- Lane Configuration: `config/allblue_lanes.json`
- Acceptance Tests: `docs/ALLBLUE_ACCEPTANCE_TESTS.md`
- Fleet State Archive: `artifacts/allblue/fleet_state.json`
