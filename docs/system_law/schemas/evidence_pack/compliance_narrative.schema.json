{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/evidence_pack/compliance_narrative.v1.0.0.json",
  "title": "Compliance Narrative Metadata",
  "description": "Schema for compliance narrative metadata. Defines required sections and NDAA requirement mapping for the prose compliance narrative document (Markdown). This schema validates the structure, not the prose content.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "document_id",
    "generated_at",
    "bundle_id",
    "sections",
    "ndaa_mapping"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "document_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this compliance narrative"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of document generation"
    },
    "bundle_id": {
      "type": "string",
      "format": "uuid",
      "description": "Parent evidence bundle identifier"
    },
    "document_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of this narrative document"
    },
    "author": {
      "type": "object",
      "description": "Document author metadata",
      "properties": {
        "name": {"type": "string"},
        "role": {"type": "string"},
        "organization": {"type": "string"}
      }
    },
    "review_status": {
      "type": "string",
      "enum": ["DRAFT", "REVIEW", "APPROVED", "FINAL"],
      "description": "Document review status"
    },
    "sections": {
      "type": "array",
      "description": "Required sections in the compliance narrative",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/section"
      }
    },
    "ndaa_mapping": {
      "type": "array",
      "description": "NDAA requirement to artifact mapping",
      "items": {
        "$ref": "#/$defs/ndaa_requirement"
      }
    },
    "artifact_references": {
      "type": "array",
      "description": "All artifacts referenced in the narrative",
      "items": {
        "type": "object",
        "properties": {
          "artifact_path": {"type": "string"},
          "reference_count": {"type": "integer", "minimum": 1},
          "sections_referenced_in": {
            "type": "array",
            "items": {"type": "string"}
          }
        }
      }
    },
    "compliance_summary": {
      "type": "object",
      "description": "High-level compliance summary",
      "properties": {
        "total_requirements": {"type": "integer", "minimum": 0},
        "requirements_addressed": {"type": "integer", "minimum": 0},
        "compliance_rate": {"type": "number", "minimum": 0, "maximum": 1},
        "status_by_requirement": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "enum": ["COMPLIANT", "PARTIAL", "PENDING", "NOT_APPLICABLE"]
          }
        }
      }
    },
    "word_counts": {
      "type": "object",
      "description": "Word count validation for sections",
      "properties": {
        "total_words": {"type": "integer", "minimum": 0},
        "by_section": {
          "type": "object",
          "additionalProperties": {"type": "integer", "minimum": 0}
        }
      }
    }
  },
  "$defs": {
    "section": {
      "type": "object",
      "required": ["id", "title", "required"],
      "description": "Required narrative section",
      "properties": {
        "id": {
          "type": "string",
          "description": "Section identifier (e.g., 'executive_summary')"
        },
        "title": {
          "type": "string",
          "description": "Section display title"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this section is required for completeness"
        },
        "order": {
          "type": "integer",
          "minimum": 1,
          "description": "Section order in document"
        },
        "word_count_min": {
          "type": "integer",
          "minimum": 0,
          "description": "Minimum word count for this section"
        },
        "word_count_max": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum word count for this section"
        },
        "artifact_refs": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Artifacts that should be referenced in this section"
        },
        "subsections": {
          "type": "array",
          "items": {"$ref": "#/$defs/section"},
          "description": "Nested subsections"
        },
        "ndaa_requirements_addressed": {
          "type": "array",
          "items": {"type": "string"},
          "description": "NDAA requirement IDs addressed in this section"
        },
        "present": {
          "type": "boolean",
          "description": "Whether this section is present in the document"
        }
      }
    },
    "ndaa_requirement": {
      "type": "object",
      "required": ["requirement_id", "requirement_text", "compliance_status"],
      "description": "NDAA requirement mapping",
      "properties": {
        "requirement_id": {
          "type": "string",
          "description": "NDAA requirement identifier"
        },
        "requirement_text": {
          "type": "string",
          "description": "Full text of the NDAA requirement"
        },
        "requirement_category": {
          "type": "string",
          "enum": [
            "RISK_INFORMED_STRATEGY",
            "TECHNICAL_CONTROLS",
            "HUMAN_OVERRIDE",
            "AUDITABILITY",
            "VERIFICATION_INDEPENDENCE",
            "OTHER"
          ],
          "description": "Category of requirement"
        },
        "artifact_refs": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Evidence artifacts supporting compliance"
        },
        "narrative_section": {
          "type": "string",
          "description": "Section ID where this requirement is addressed"
        },
        "compliance_status": {
          "type": "string",
          "enum": ["COMPLIANT", "PARTIAL", "PENDING", "NOT_APPLICABLE"],
          "description": "Current compliance status"
        },
        "compliance_evidence": {
          "type": "string",
          "description": "Summary of evidence supporting compliance"
        },
        "gaps_identified": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Identified gaps in compliance"
        },
        "remediation_plan": {
          "type": "string",
          "description": "Plan to address gaps (if any)"
        }
      }
    }
  }
}
