{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/evidence_pack/evidence_bundle.v1.0.0.json",
  "title": "Evidence Pack Bundle Manifest",
  "description": "Schema for Evidence Pack bundle manifest. Provides artifact inventory, checksums, completeness verification, and cryptographic attestation root for Phase X whitepaper evidence packages.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "bundle_id",
    "bundle_version",
    "generated_at",
    "p3_run_id",
    "p4_run_id",
    "artifacts",
    "completeness",
    "cryptographic_root"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "bundle_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this evidence bundle (UUID v4)"
    },
    "bundle_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version of bundle format"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of bundle generation"
    },
    "generator": {
      "type": "object",
      "description": "Bundle generator metadata",
      "properties": {
        "name": {"type": "string"},
        "version": {"type": "string"},
        "commit_hash": {"type": "string", "pattern": "^[a-f0-9]{40}$"}
      }
    },
    "p3_run_id": {
      "type": "string",
      "description": "Source P3 (synthetic) run identifier"
    },
    "p4_run_id": {
      "type": "string",
      "description": "Source P4 (real-coupled) run identifier"
    },
    "run_metadata": {
      "type": "object",
      "description": "Metadata about source runs",
      "properties": {
        "p3": {
          "type": "object",
          "properties": {
            "start_time": {"type": "string", "format": "date-time"},
            "end_time": {"type": "string", "format": "date-time"},
            "cycles_completed": {"type": "integer", "minimum": 0},
            "slice_name": {"type": "string"},
            "runner_type": {"type": "string"}
          }
        },
        "p4": {
          "type": "object",
          "properties": {
            "start_time": {"type": "string", "format": "date-time"},
            "end_time": {"type": "string", "format": "date-time"},
            "cycles_completed": {"type": "integer", "minimum": 0},
            "slice_name": {"type": "string"},
            "runner_type": {"type": "string"}
          }
        }
      }
    },
    "artifacts": {
      "type": "array",
      "description": "Complete inventory of artifacts in this bundle",
      "items": {
        "$ref": "#/$defs/artifact"
      }
    },
    "completeness": {
      "$ref": "#/$defs/completeness",
      "description": "Required artifact checklist for validation"
    },
    "cryptographic_root": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "Merkle root hash of all artifact hashes (sha256:hex format)"
    },
    "merkle_tree": {
      "type": "object",
      "description": "Full Merkle tree structure for audit",
      "properties": {
        "algorithm": {"type": "string", "const": "sha256"},
        "leaf_count": {"type": "integer", "minimum": 1},
        "tree_depth": {"type": "integer", "minimum": 1},
        "internal_nodes": {
          "type": "array",
          "items": {"type": "string", "pattern": "^[a-f0-9]{64}$"}
        }
      }
    },
    "validation_status": {
      "type": "object",
      "description": "Bundle self-validation results",
      "properties": {
        "all_artifacts_present": {"type": "boolean"},
        "all_hashes_verified": {"type": "boolean"},
        "all_schemas_valid": {"type": "boolean"},
        "completeness_check_passed": {"type": "boolean"},
        "validation_timestamp": {"type": "string", "format": "date-time"},
        "validation_errors": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    }
  },
  "$defs": {
    "artifact": {
      "type": "object",
      "required": ["path", "sha256", "size_bytes", "category"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Relative path within bundle"
        },
        "sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of file contents"
        },
        "size_bytes": {
          "type": "integer",
          "minimum": 0,
          "description": "File size in bytes"
        },
        "category": {
          "type": "string",
          "enum": ["p3_synthetic", "p4_shadow", "visualization", "compliance", "schema"],
          "description": "Artifact category"
        },
        "schema_ref": {
          "type": "string",
          "description": "Reference to validation schema ($id)"
        },
        "format": {
          "type": "string",
          "enum": ["json", "jsonl", "svg", "md", "txt"],
          "description": "File format"
        },
        "description": {
          "type": "string",
          "description": "Human-readable artifact description"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this artifact is required for bundle completeness"
        }
      }
    },
    "completeness": {
      "type": "object",
      "required": ["p3_artifacts", "p4_artifacts", "visualizations", "compliance"],
      "description": "Checklist of required artifacts by category",
      "properties": {
        "p3_artifacts": {
          "$ref": "#/$defs/artifact_checklist",
          "description": "P3 synthetic phase artifacts"
        },
        "p4_artifacts": {
          "$ref": "#/$defs/artifact_checklist",
          "description": "P4 real-coupled phase artifacts"
        },
        "visualizations": {
          "$ref": "#/$defs/artifact_checklist",
          "description": "Generated visualization files"
        },
        "compliance": {
          "$ref": "#/$defs/artifact_checklist",
          "description": "Compliance documentation"
        },
        "all_required_present": {
          "type": "boolean",
          "description": "Whether all required artifacts are present"
        },
        "missing_artifacts": {
          "type": "array",
          "items": {"type": "string"},
          "description": "List of missing required artifacts"
        }
      }
    },
    "artifact_checklist": {
      "type": "object",
      "description": "Checklist mapping artifact names to presence",
      "additionalProperties": {
        "type": "boolean"
      }
    }
  }
}
