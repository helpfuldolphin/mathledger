{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/topology/topology_bundle_joint_view.v1.0.0.json",
  "title": "Topology Bundle Joint View",
  "description": "Schema for combined topology-bundle observation snapshots in Phase X P4 shadow coupling. Captures the joint state of topological metrics and provenance bundle at a given cycle. SHADOW MODE: logged only, no enforcement.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "cycle",
    "timestamp",
    "mode",
    "topology_snapshot",
    "bundle_snapshot",
    "alignment_status"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "cycle": {
      "type": "integer",
      "minimum": 1,
      "description": "Cycle index (1-indexed)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of joint observation"
    },
    "mode": {
      "type": "string",
      "const": "SHADOW",
      "description": "Observation mode - always SHADOW in Phase X"
    },
    "topology_snapshot": {
      "type": "object",
      "required": ["topology_mode", "betti_0", "betti_1", "persistence_stability", "in_omega"],
      "properties": {
        "topology_mode": {
          "type": "string",
          "enum": ["STABLE", "DRIFT", "TURBULENT", "CRITICAL"],
          "description": "Current topology mode classification"
        },
        "betti_0": {
          "type": "integer",
          "minimum": 0,
          "description": "0th Betti number: connected components"
        },
        "betti_1": {
          "type": "integer",
          "minimum": 0,
          "description": "1st Betti number: 1-dimensional holes"
        },
        "persistence_stability": {
          "type": "number",
          "minimum": 0,
          "description": "Bottleneck distance from previous persistence diagram"
        },
        "persistence_entropy": {
          "type": "number",
          "minimum": 0,
          "description": "Entropy of persistence diagram"
        },
        "in_omega": {
          "type": "boolean",
          "description": "True if state is within safe region Omega"
        },
        "omega_boundary_distance": {
          "type": "number",
          "minimum": 0,
          "description": "Normalized distance to Omega boundary"
        },
        "trajectory_curvature": {
          "type": "number",
          "minimum": 0,
          "description": "Local curvature of state trajectory"
        },
        "topology_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of topology snapshot"
        }
      },
      "description": "Topology metrics snapshot at this cycle"
    },
    "bundle_snapshot": {
      "type": "object",
      "required": ["bundle_id", "bundle_status", "manifest_valid"],
      "properties": {
        "bundle_id": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of bundle manifest"
        },
        "bundle_status": {
          "type": "string",
          "enum": ["VALID", "WARN", "INVALID", "MISSING"],
          "description": "Bundle provenance status"
        },
        "bundle_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO8601 timestamp of bundle creation"
        },
        "manifest_valid": {
          "type": "boolean",
          "description": "True if bundle manifest is valid and complete"
        },
        "source_file_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of source files in bundle"
        },
        "trace_file_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of trace files in bundle"
        },
        "manifest_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of source file manifest"
        },
        "trace_coverage": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of execution covered by traces"
        },
        "bundle_age_seconds": {
          "type": "number",
          "minimum": 0,
          "description": "Age of bundle in seconds (since creation)"
        },
        "bundle_age_warning": {
          "type": "boolean",
          "description": "True if bundle age exceeds threshold"
        }
      },
      "description": "Bundle provenance snapshot at this cycle"
    },
    "alignment_status": {
      "type": "object",
      "required": ["topology_bundle_aligned", "overall_status"],
      "properties": {
        "topology_bundle_aligned": {
          "type": "boolean",
          "description": "True if topology and bundle states are aligned"
        },
        "overall_status": {
          "type": "string",
          "enum": ["ALIGNED", "TENSION", "DIVERGENT"],
          "description": "Overall alignment state between topology and bundle"
        },
        "topology_status": {
          "type": "string",
          "enum": ["OK", "WARN", "CRITICAL"],
          "description": "Topology contribution to alignment"
        },
        "bundle_status_contribution": {
          "type": "string",
          "enum": ["OK", "WARN", "CRITICAL"],
          "description": "Bundle contribution to alignment"
        },
        "tension_reasons": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^\\[(TOPO|BNDL)\\].*"
          },
          "description": "Reasons for tension/divergence (prefixed with source)"
        }
      },
      "description": "Alignment status between topology and bundle"
    },
    "divergence_correlation": {
      "type": "object",
      "properties": {
        "p4_divergence_active": {
          "type": "boolean",
          "description": "True if P4 divergence detected at this cycle"
        },
        "p4_divergence_severity": {
          "type": "string",
          "enum": ["NONE", "INFO", "WARN", "CRITICAL"],
          "description": "P4 divergence severity if active"
        },
        "topology_preceded_divergence": {
          "type": "boolean",
          "description": "True if topology drift preceded this divergence"
        },
        "bundle_anomaly_at_divergence": {
          "type": "boolean",
          "description": "True if bundle anomaly detected at divergence"
        },
        "triple_fault": {
          "type": "boolean",
          "description": "True if topology+bundle+divergence triple fault"
        },
        "correlation_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in topology-divergence correlation"
        }
      },
      "description": "Cross-correlation with P4 divergence analysis"
    },
    "governance_signals": {
      "type": "object",
      "properties": {
        "topology_codes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^TOPO-(OK|WARN|CRIT)-[0-9]{3}$"
          },
          "description": "Active topology signal codes"
        },
        "bundle_codes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^BNDL-(OK|WARN|CRIT)-[0-9]{3}$"
          },
          "description": "Active bundle signal codes"
        },
        "correlation_codes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^XCOR-(OK|WARN|CRIT)-[0-9]{3}$"
          },
          "description": "Active cross-correlation signal codes"
        },
        "highest_severity": {
          "type": "string",
          "enum": ["OK", "WARN", "CRITICAL"],
          "description": "Highest severity across all signals"
        },
        "hypothetical_action": {
          "type": "string",
          "enum": ["CONTINUE", "CAUTION", "PAUSE", "ABORT"],
          "description": "Action that WOULD be taken if not in SHADOW mode"
        }
      },
      "description": "Governance signals summary (SHADOW: logged only)"
    },
    "runner_context": {
      "type": "object",
      "properties": {
        "runner_type": {
          "type": "string",
          "enum": ["u2", "rfl"],
          "description": "Type of runner being observed"
        },
        "slice_name": {
          "type": "string",
          "description": "Name of curriculum slice"
        },
        "runner_success": {
          "type": "boolean",
          "description": "Runner success status at this cycle"
        },
        "usla_H": {
          "type": "number",
          "description": "USLA health metric at this cycle"
        },
        "usla_rho": {
          "type": "number",
          "description": "USLA RSI at this cycle"
        }
      },
      "description": "Runner context for this observation"
    },
    "joint_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA-256 hash of combined topology+bundle snapshot for audit"
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "cycle": 142,
      "timestamp": "2025-12-10T00:02:22.000Z",
      "mode": "SHADOW",
      "topology_snapshot": {
        "topology_mode": "STABLE",
        "betti_0": 1,
        "betti_1": 0,
        "persistence_stability": 0.03,
        "persistence_entropy": 0.25,
        "in_omega": true,
        "omega_boundary_distance": 0.42,
        "trajectory_curvature": 0.08,
        "topology_hash": "sha256:abc123..."
      },
      "bundle_snapshot": {
        "bundle_id": "sha256:def456...",
        "bundle_status": "VALID",
        "bundle_timestamp": "2025-12-10T00:02:20.000Z",
        "manifest_valid": true,
        "source_file_count": 15,
        "trace_file_count": 3,
        "manifest_hash": "sha256:ghi789...",
        "trace_coverage": 0.95,
        "bundle_age_seconds": 2.0,
        "bundle_age_warning": false
      },
      "alignment_status": {
        "topology_bundle_aligned": true,
        "overall_status": "ALIGNED",
        "topology_status": "OK",
        "bundle_status_contribution": "OK",
        "tension_reasons": []
      },
      "divergence_correlation": {
        "p4_divergence_active": false,
        "p4_divergence_severity": "NONE",
        "topology_preceded_divergence": false,
        "bundle_anomaly_at_divergence": false,
        "triple_fault": false,
        "correlation_confidence": 0.0
      },
      "governance_signals": {
        "topology_codes": ["TOPO-OK-001", "TOPO-OK-002"],
        "bundle_codes": ["BNDL-OK-001", "BNDL-OK-002"],
        "correlation_codes": ["XCOR-OK-001"],
        "highest_severity": "OK",
        "hypothetical_action": "CONTINUE"
      },
      "runner_context": {
        "runner_type": "u2",
        "slice_name": "arithmetic_simple",
        "runner_success": true,
        "usla_H": 0.82,
        "usla_rho": 0.88
      },
      "joint_hash": "sha256:jkl012..."
    },
    {
      "schema_version": "1.0.0",
      "cycle": 567,
      "timestamp": "2025-12-10T00:09:27.000Z",
      "mode": "SHADOW",
      "topology_snapshot": {
        "topology_mode": "DRIFT",
        "betti_0": 1,
        "betti_1": 2,
        "persistence_stability": 0.12,
        "persistence_entropy": 0.48,
        "in_omega": true,
        "omega_boundary_distance": 0.08,
        "trajectory_curvature": 0.31,
        "topology_hash": "sha256:mno345..."
      },
      "bundle_snapshot": {
        "bundle_id": "sha256:pqr678...",
        "bundle_status": "WARN",
        "bundle_timestamp": "2025-12-10T00:09:00.000Z",
        "manifest_valid": true,
        "source_file_count": 15,
        "trace_file_count": 2,
        "manifest_hash": "sha256:stu901...",
        "trace_coverage": 0.78,
        "bundle_age_seconds": 27.0,
        "bundle_age_warning": true
      },
      "alignment_status": {
        "topology_bundle_aligned": false,
        "overall_status": "TENSION",
        "topology_status": "WARN",
        "bundle_status_contribution": "WARN",
        "tension_reasons": [
          "[TOPO] Persistence stability approaching threshold (0.12 / 0.15)",
          "[BNDL] Bundle age exceeds threshold (27s > 20s)"
        ]
      },
      "divergence_correlation": {
        "p4_divergence_active": true,
        "p4_divergence_severity": "WARN",
        "topology_preceded_divergence": true,
        "bundle_anomaly_at_divergence": false,
        "triple_fault": false,
        "correlation_confidence": 0.72
      },
      "governance_signals": {
        "topology_codes": ["TOPO-OK-001", "TOPO-WARN-001", "TOPO-WARN-002"],
        "bundle_codes": ["BNDL-OK-001", "BNDL-WARN-001"],
        "correlation_codes": ["XCOR-WARN-001"],
        "highest_severity": "WARN",
        "hypothetical_action": "CAUTION"
      },
      "runner_context": {
        "runner_type": "u2",
        "slice_name": "arithmetic_simple",
        "runner_success": false,
        "usla_H": 0.58,
        "usla_rho": 0.62
      },
      "joint_hash": "sha256:vwx234..."
    }
  ]
}
