{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/topology/topology_drift_compass.v1.0.0.json",
  "title": "Topology Drift Compass",
  "description": "Schema for topology drift observation records in Phase X P3/P4 shadow experiments. JSONL format: one record per cycle. SHADOW MODE: logged only, no enforcement.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "cycle",
    "timestamp",
    "mode",
    "topology_mode",
    "betti_numbers",
    "persistence_metrics",
    "safe_region_metrics"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "cycle": {
      "type": "integer",
      "minimum": 1,
      "description": "Cycle index (1-indexed)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of observation"
    },
    "mode": {
      "type": "string",
      "const": "SHADOW",
      "description": "Observation mode - always SHADOW in Phase X"
    },
    "topology_mode": {
      "type": "string",
      "enum": ["STABLE", "DRIFT", "TURBULENT", "CRITICAL"],
      "description": "Current topology mode classification"
    },
    "betti_numbers": {
      "type": "object",
      "required": ["beta_0", "beta_1"],
      "properties": {
        "beta_0": {
          "type": "integer",
          "minimum": 0,
          "description": "0th Betti number: connected components (expected 1)"
        },
        "beta_1": {
          "type": "integer",
          "minimum": 0,
          "description": "1st Betti number: 1-dimensional holes/cycles"
        },
        "beta_0_bound_violation": {
          "type": "boolean",
          "description": "True if beta_0 is outside [1,1] bounds"
        },
        "beta_1_bound_violation": {
          "type": "boolean",
          "description": "True if beta_1 is outside [0,3] bounds"
        }
      },
      "description": "Betti number observations for state space topology"
    },
    "persistence_metrics": {
      "type": "object",
      "required": ["persistence_entropy", "max_persistence", "persistence_stability"],
      "properties": {
        "persistence_entropy": {
          "type": "number",
          "minimum": 0,
          "description": "Entropy of persistence diagram (complexity measure)"
        },
        "max_persistence": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum persistence interval length"
        },
        "persistence_stability": {
          "type": "number",
          "minimum": 0,
          "description": "Bottleneck distance from previous cycle's persistence diagram"
        },
        "persistence_drift_threshold": {
          "type": "number",
          "default": 0.15,
          "description": "Threshold for persistence drift warning"
        },
        "persistence_drift_violation": {
          "type": "boolean",
          "description": "True if persistence_stability exceeds threshold"
        }
      },
      "description": "Persistence diagram metrics for topological stability"
    },
    "safe_region_metrics": {
      "type": "object",
      "required": ["in_omega", "omega_convexity", "omega_boundary_distance"],
      "properties": {
        "in_omega": {
          "type": "boolean",
          "description": "True if current state is within safe region Omega"
        },
        "omega_convexity": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Convexity measure of Omega occupancy (1.0 = fully convex)"
        },
        "omega_boundary_distance": {
          "type": "number",
          "minimum": 0,
          "description": "Normalized distance to Omega boundary (0 = on boundary)"
        },
        "consecutive_outside_omega": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of consecutive cycles outside Omega"
        },
        "omega_topology_violation": {
          "type": "boolean",
          "description": "True if Omega has non-trivial topology (holes, disconnection)"
        }
      },
      "description": "Safe region topology metrics"
    },
    "trajectory_metrics": {
      "type": "object",
      "properties": {
        "trajectory_curvature": {
          "type": "number",
          "minimum": 0,
          "description": "Local curvature of state path"
        },
        "curvature_variance": {
          "type": "number",
          "minimum": 0,
          "description": "Variance of curvature over observation window"
        },
        "curvature_spike": {
          "type": "boolean",
          "description": "True if curvature exceeds spike threshold"
        }
      },
      "description": "State trajectory metrics"
    },
    "governance_signals": {
      "type": "object",
      "properties": {
        "active_codes": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^(TOPO|BNDL|XCOR)-(OK|WARN|CRIT)-[0-9]{3}$"
          },
          "description": "List of active governance signal codes"
        },
        "highest_severity": {
          "type": "string",
          "enum": ["OK", "WARN", "CRITICAL"],
          "description": "Highest severity among active signals"
        },
        "hypothetical_action": {
          "type": "string",
          "enum": ["CONTINUE", "CAUTION", "PAUSE", "ABORT"],
          "description": "What action WOULD be taken if not in SHADOW mode"
        }
      },
      "description": "Governance signal summary (SHADOW: logged only)"
    },
    "mode_transition": {
      "type": "object",
      "properties": {
        "previous_mode": {
          "type": "string",
          "enum": ["STABLE", "DRIFT", "TURBULENT", "CRITICAL", "UNKNOWN"],
          "description": "Topology mode in previous cycle"
        },
        "transition_occurred": {
          "type": "boolean",
          "description": "True if mode changed from previous cycle"
        },
        "transition_direction": {
          "type": "string",
          "enum": ["IMPROVING", "DEGRADING", "STABLE", "N/A"],
          "description": "Direction of mode transition"
        }
      },
      "description": "Mode transition tracking"
    },
    "correlation_hints": {
      "type": "object",
      "properties": {
        "divergence_predicted": {
          "type": "boolean",
          "description": "True if topology drift suggests upcoming P4 divergence"
        },
        "bundle_anomaly_correlated": {
          "type": "boolean",
          "description": "True if bundle anomaly detected in same window"
        },
        "triple_fault_risk": {
          "type": "boolean",
          "description": "True if topology+bundle+divergence triple fault possible"
        }
      },
      "description": "Cross-correlation hints for P4 analysis"
    },
    "telemetry_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA-256 hash of this observation for audit trail"
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "cycle": 42,
      "timestamp": "2025-12-10T00:00:42.000Z",
      "mode": "SHADOW",
      "topology_mode": "STABLE",
      "betti_numbers": {
        "beta_0": 1,
        "beta_1": 0,
        "beta_0_bound_violation": false,
        "beta_1_bound_violation": false
      },
      "persistence_metrics": {
        "persistence_entropy": 0.23,
        "max_persistence": 0.85,
        "persistence_stability": 0.02,
        "persistence_drift_threshold": 0.15,
        "persistence_drift_violation": false
      },
      "safe_region_metrics": {
        "in_omega": true,
        "omega_convexity": 0.98,
        "omega_boundary_distance": 0.35,
        "consecutive_outside_omega": 0,
        "omega_topology_violation": false
      },
      "trajectory_metrics": {
        "trajectory_curvature": 0.12,
        "curvature_variance": 0.005,
        "curvature_spike": false
      },
      "governance_signals": {
        "active_codes": ["TOPO-OK-001", "TOPO-OK-002", "TOPO-OK-003"],
        "highest_severity": "OK",
        "hypothetical_action": "CONTINUE"
      },
      "mode_transition": {
        "previous_mode": "STABLE",
        "transition_occurred": false,
        "transition_direction": "STABLE"
      },
      "correlation_hints": {
        "divergence_predicted": false,
        "bundle_anomaly_correlated": false,
        "triple_fault_risk": false
      },
      "telemetry_hash": "sha256:abc123def456789..."
    },
    {
      "schema_version": "1.0.0",
      "cycle": 142,
      "timestamp": "2025-12-10T00:02:22.000Z",
      "mode": "SHADOW",
      "topology_mode": "DRIFT",
      "betti_numbers": {
        "beta_0": 1,
        "beta_1": 2,
        "beta_0_bound_violation": false,
        "beta_1_bound_violation": false
      },
      "persistence_metrics": {
        "persistence_entropy": 0.45,
        "max_persistence": 0.72,
        "persistence_stability": 0.11,
        "persistence_drift_threshold": 0.15,
        "persistence_drift_violation": false
      },
      "safe_region_metrics": {
        "in_omega": true,
        "omega_convexity": 0.85,
        "omega_boundary_distance": 0.12,
        "consecutive_outside_omega": 0,
        "omega_topology_violation": false
      },
      "trajectory_metrics": {
        "trajectory_curvature": 0.28,
        "curvature_variance": 0.015,
        "curvature_spike": false
      },
      "governance_signals": {
        "active_codes": ["TOPO-OK-001", "TOPO-WARN-001"],
        "highest_severity": "WARN",
        "hypothetical_action": "CAUTION"
      },
      "mode_transition": {
        "previous_mode": "STABLE",
        "transition_occurred": true,
        "transition_direction": "DEGRADING"
      },
      "correlation_hints": {
        "divergence_predicted": true,
        "bundle_anomaly_correlated": false,
        "triple_fault_risk": false
      },
      "telemetry_hash": "sha256:def789abc123456..."
    }
  ]
}
