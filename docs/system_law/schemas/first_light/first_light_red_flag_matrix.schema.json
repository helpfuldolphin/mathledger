{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/first_light/red_flag_matrix.v1.0.0.json",
  "title": "First-Light Red Flag Matrix",
  "description": "Schema for red-flag observation matrix in P3 First-Light experiments. Contains all red-flag events with severity classification.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "run_id",
    "timestamp",
    "total_cycles",
    "flags",
    "summary"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "run_id": {
      "type": "string",
      "description": "Unique identifier for this First-Light run"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp when matrix was generated"
    },
    "total_cycles": {
      "type": "integer",
      "minimum": 1,
      "description": "Total number of cycles in this run"
    },
    "flags": {
      "type": "array",
      "description": "Array of individual red-flag events",
      "items": {
        "type": "object",
        "required": ["cycle", "flag_type", "severity"],
        "properties": {
          "cycle": {
            "type": "integer",
            "minimum": 1,
            "description": "Cycle at which flag was raised"
          },
          "flag_type": {
            "type": "string",
            "enum": [
              "DELTA_P_SPIKE",
              "DELTA_P_COLLAPSE",
              "DRIFT_EXCEEDANCE",
              "OSCILLATION",
              "RSI_COLLAPSE",
              "OMEGA_EXIT",
              "HARD_FAIL",
              "GOVERNANCE_DIVERGENCE",
              "CDI_007",
              "CDI_010",
              "BLOCK_RATE_EXPLOSION"
            ],
            "description": "Type of red-flag event"
          },
          "severity": {
            "type": "string",
            "enum": ["INFO", "WARN", "CRITICAL"],
            "description": "Severity classification"
          },
          "value": {
            "type": "number",
            "description": "Observed value that triggered the flag"
          },
          "threshold": {
            "type": "number",
            "description": "Threshold that was exceeded"
          },
          "streak_length": {
            "type": "integer",
            "minimum": 1,
            "description": "Current streak length if applicable"
          },
          "context": {
            "type": "object",
            "description": "Additional context for this flag event",
            "additionalProperties": true
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "required": ["total_flags", "by_severity", "by_type"],
      "properties": {
        "total_flags": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of red-flag events"
        },
        "by_severity": {
          "type": "object",
          "properties": {
            "INFO": {"type": "integer", "minimum": 0},
            "WARN": {"type": "integer", "minimum": 0},
            "CRITICAL": {"type": "integer", "minimum": 0}
          },
          "description": "Flag counts by severity"
        },
        "by_type": {
          "type": "object",
          "additionalProperties": {"type": "integer", "minimum": 0},
          "description": "Flag counts by type"
        },
        "max_streaks": {
          "type": "object",
          "additionalProperties": {"type": "integer", "minimum": 0},
          "description": "Maximum streak lengths by flag type"
        },
        "hypothetical_abort": {
          "type": "object",
          "properties": {
            "would_abort": {
              "type": "boolean",
              "description": "Whether abort would have been triggered (SHADOW MODE: logged only)"
            },
            "abort_cycle": {
              "type": ["integer", "null"],
              "description": "Cycle at which abort would have triggered"
            },
            "abort_reason": {
              "type": ["string", "null"],
              "description": "Reason for hypothetical abort"
            }
          },
          "description": "Hypothetical abort analysis (SHADOW MODE: for analysis only)"
        }
      }
    }
  }
}
