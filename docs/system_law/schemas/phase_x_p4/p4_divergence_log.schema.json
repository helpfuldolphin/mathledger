{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/phase_x_p4/divergence_log.v1.0.0.json",
  "title": "P4 Divergence Log Record",
  "description": "Schema for individual divergence records in P4 real-runner shadow coupling. JSONL format: one record per line. SHADOW MODE: logged only, no enforcement.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "cycle",
    "timestamp",
    "twin_delta_p",
    "real_delta_p",
    "divergence",
    "divergence_pct",
    "severity"
  ],
  "properties": {
    "cycle": {
      "type": "integer",
      "minimum": 1,
      "description": "Cycle index (1-indexed)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of observation"
    },
    "twin_delta_p": {
      "type": "number",
      "description": "Delta-p predicted by shadow twin"
    },
    "real_delta_p": {
      "type": "number",
      "description": "Delta-p observed from real runner"
    },
    "divergence": {
      "type": "number",
      "minimum": 0,
      "description": "Absolute divergence: |real_delta_p - twin_delta_p|"
    },
    "divergence_pct": {
      "type": "number",
      "minimum": 0,
      "description": "Percentage divergence: divergence / max(|real_delta_p|, epsilon)"
    },
    "severity": {
      "type": "string",
      "enum": ["NONE", "INFO", "WARN", "CRITICAL"],
      "description": "Severity classification per Phase_X_Divergence_Metric.md"
    },
    "twin_state": {
      "type": "object",
      "description": "Full twin state snapshot at this cycle",
      "properties": {
        "H": {"type": "number"},
        "rho": {"type": "number"},
        "tau": {"type": "number"},
        "beta": {"type": "number"},
        "in_omega": {"type": "boolean"},
        "success": {"type": "boolean"}
      }
    },
    "real_state": {
      "type": "object",
      "description": "Full real state snapshot at this cycle",
      "properties": {
        "H": {"type": "number"},
        "rho": {"type": "number"},
        "tau": {"type": "number"},
        "beta": {"type": "number"},
        "in_omega": {"type": "boolean"},
        "success": {"type": "boolean"}
      }
    },
    "state_divergences": {
      "type": "object",
      "description": "Per-field divergence between twin and real",
      "properties": {
        "H_diff": {"type": "number"},
        "rho_diff": {"type": "number"},
        "tau_diff": {"type": "number"},
        "beta_diff": {"type": "number"},
        "omega_mismatch": {"type": "boolean"},
        "success_mismatch": {"type": "boolean"}
      }
    },
    "telemetry_snapshot_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA-256 hash of the telemetry snapshot for audit trail"
    },
    "streak_length": {
      "type": "integer",
      "minimum": 0,
      "description": "Current divergence streak length"
    }
  }
}
