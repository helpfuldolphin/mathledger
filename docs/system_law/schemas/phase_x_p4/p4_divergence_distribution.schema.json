{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/phase_x_p4/divergence_distribution.v1.0.0.json",
  "title": "P4 Divergence Distribution",
  "description": "Schema for P4 divergence distribution statistics. Contains statistical analysis of twin-vs-real divergence magnitudes, severity distributions, streak analysis, and correlation metrics. SHADOW MODE: all analysis is observational only.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "run_id",
    "generated_at",
    "total_cycles",
    "distribution",
    "severity_counts",
    "streak_analysis"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "run_id": {
      "type": "string",
      "description": "Unique identifier for this P4 run"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of distribution computation"
    },
    "mode": {
      "type": "string",
      "const": "SHADOW",
      "description": "Operating mode (always SHADOW in P4)"
    },
    "total_cycles": {
      "type": "integer",
      "minimum": 1,
      "description": "Total number of cycles analyzed"
    },
    "divergence_metric": {
      "type": "object",
      "description": "Definition of divergence metric used",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["L1", "L2", "PERCENTAGE", "MAX_COMPONENT"],
          "description": "Type of divergence metric"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of metric"
        },
        "formula": {
          "type": "string",
          "description": "Mathematical formula for divergence computation"
        }
      }
    },
    "distribution": {
      "type": "object",
      "required": ["mean", "std", "min", "max", "percentiles"],
      "description": "Statistical distribution of divergence values",
      "properties": {
        "mean": {
          "type": "number",
          "minimum": 0,
          "description": "Mean divergence value"
        },
        "std": {
          "type": "number",
          "minimum": 0,
          "description": "Standard deviation of divergence"
        },
        "min": {
          "type": "number",
          "minimum": 0,
          "description": "Minimum observed divergence"
        },
        "max": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum observed divergence"
        },
        "median": {
          "type": "number",
          "minimum": 0,
          "description": "Median divergence"
        },
        "variance": {
          "type": "number",
          "minimum": 0,
          "description": "Variance of divergence"
        },
        "skewness": {
          "type": "number",
          "description": "Skewness of distribution"
        },
        "kurtosis": {
          "type": "number",
          "description": "Kurtosis of distribution"
        },
        "percentiles": {
          "type": "object",
          "description": "Percentile values",
          "properties": {
            "p10": {"type": "number", "minimum": 0},
            "p25": {"type": "number", "minimum": 0},
            "p50": {"type": "number", "minimum": 0},
            "p75": {"type": "number", "minimum": 0},
            "p90": {"type": "number", "minimum": 0},
            "p95": {"type": "number", "minimum": 0},
            "p99": {"type": "number", "minimum": 0}
          }
        },
        "histogram_bins": {
          "type": "array",
          "description": "Histogram of divergence values",
          "items": {
            "$ref": "#/$defs/histogram_bin"
          }
        },
        "fitted_distribution": {
          "type": "object",
          "description": "Best-fit parametric distribution",
          "properties": {
            "name": {"type": "string"},
            "parameters": {"type": "object"},
            "goodness_of_fit": {"type": "number"}
          }
        }
      }
    },
    "severity_counts": {
      "type": "object",
      "required": ["NONE", "INFO", "WARN", "CRITICAL"],
      "description": "Divergence counts by severity level",
      "properties": {
        "NONE": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles with no divergence"
        },
        "INFO": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles with INFO-level divergence"
        },
        "WARN": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles with WARN-level divergence"
        },
        "CRITICAL": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles with CRITICAL-level divergence"
        }
      }
    },
    "severity_rates": {
      "type": "object",
      "description": "Divergence rates by severity (fractions)",
      "properties": {
        "none_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles with no divergence"
        },
        "info_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles with INFO divergence"
        },
        "warn_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles with WARN divergence"
        },
        "critical_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles with CRITICAL divergence"
        },
        "any_divergence_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles with any divergence"
        }
      }
    },
    "severity_thresholds": {
      "type": "object",
      "description": "Threshold values defining severity levels",
      "properties": {
        "info_threshold": {
          "type": "number",
          "minimum": 0,
          "description": "Divergence threshold for INFO"
        },
        "warn_threshold": {
          "type": "number",
          "minimum": 0,
          "description": "Divergence threshold for WARN"
        },
        "critical_threshold": {
          "type": "number",
          "minimum": 0,
          "description": "Divergence threshold for CRITICAL"
        }
      }
    },
    "streak_analysis": {
      "type": "object",
      "description": "Analysis of consecutive divergence streaks",
      "properties": {
        "max_streak": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum consecutive cycles with divergence"
        },
        "mean_streak": {
          "type": "number",
          "minimum": 0,
          "description": "Mean streak length"
        },
        "median_streak": {
          "type": "number",
          "minimum": 0,
          "description": "Median streak length"
        },
        "total_streaks": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of distinct streaks"
        },
        "streak_distribution": {
          "type": "array",
          "description": "Distribution of streak lengths",
          "items": {
            "type": "object",
            "properties": {
              "length": {"type": "integer", "minimum": 1},
              "count": {"type": "integer", "minimum": 0}
            }
          }
        },
        "max_critical_streak": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum consecutive CRITICAL-level divergences"
        },
        "streak_events": {
          "type": "array",
          "description": "Individual streak events (top N by length)",
          "items": {
            "$ref": "#/$defs/streak_event"
          }
        }
      }
    },
    "correlation_matrix": {
      "type": "object",
      "description": "Correlation between divergence and state variables",
      "properties": {
        "H_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with H (entropy)"
        },
        "rho_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with RSI (rho)"
        },
        "tau_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with threshold (tau)"
        },
        "beta_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with block rate (beta)"
        },
        "cycle_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with cycle number (trend)"
        },
        "success_correlation": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Correlation with success outcome"
        }
      }
    },
    "temporal_analysis": {
      "type": "object",
      "description": "Temporal patterns in divergence",
      "properties": {
        "trend_slope": {
          "type": "number",
          "description": "Linear trend slope of divergence over cycles"
        },
        "trend_significance": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "P-value for trend significance"
        },
        "early_divergence_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Divergence rate in first 20% of cycles"
        },
        "late_divergence_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Divergence rate in last 20% of cycles"
        },
        "autocorrelation_lag1": {
          "type": "number",
          "minimum": -1,
          "maximum": 1,
          "description": "Lag-1 autocorrelation of divergence"
        }
      }
    },
    "component_divergences": {
      "type": "object",
      "description": "Divergence statistics per state component",
      "properties": {
        "H": {"$ref": "#/$defs/component_stats"},
        "rho": {"$ref": "#/$defs/component_stats"},
        "tau": {"$ref": "#/$defs/component_stats"},
        "beta": {"$ref": "#/$defs/component_stats"},
        "delta_p": {"$ref": "#/$defs/component_stats"}
      }
    },
    "outcome_divergences": {
      "type": "object",
      "description": "Divergence statistics for binary outcomes",
      "properties": {
        "success_mismatch_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles where success prediction mismatched"
        },
        "blocked_mismatch_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles where blocked prediction mismatched"
        },
        "omega_mismatch_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles where Omega prediction mismatched"
        },
        "hard_ok_mismatch_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles where HARD-OK prediction mismatched"
        },
        "any_outcome_mismatch_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Rate of any outcome mismatch"
        }
      }
    }
  },
  "$defs": {
    "histogram_bin": {
      "type": "object",
      "description": "Single histogram bin",
      "properties": {
        "bin_low": {
          "type": "number",
          "description": "Lower bound of bin"
        },
        "bin_high": {
          "type": "number",
          "description": "Upper bound of bin"
        },
        "count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of samples in bin"
        },
        "density": {
          "type": "number",
          "minimum": 0,
          "description": "Probability density"
        },
        "cumulative": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Cumulative probability"
        }
      }
    },
    "streak_event": {
      "type": "object",
      "description": "Individual streak event",
      "properties": {
        "start_cycle": {
          "type": "integer",
          "minimum": 1,
          "description": "First cycle of streak"
        },
        "end_cycle": {
          "type": "integer",
          "minimum": 1,
          "description": "Last cycle of streak"
        },
        "length": {
          "type": "integer",
          "minimum": 1,
          "description": "Streak length in cycles"
        },
        "max_severity": {
          "type": "string",
          "enum": ["INFO", "WARN", "CRITICAL"],
          "description": "Maximum severity in streak"
        },
        "mean_divergence": {
          "type": "number",
          "minimum": 0,
          "description": "Mean divergence during streak"
        }
      }
    },
    "component_stats": {
      "type": "object",
      "description": "Statistics for a single state component",
      "properties": {
        "mean_absolute_diff": {
          "type": "number",
          "minimum": 0,
          "description": "Mean |twin - real| for this component"
        },
        "max_absolute_diff": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum |twin - real|"
        },
        "std_diff": {
          "type": "number",
          "minimum": 0,
          "description": "Standard deviation of differences"
        },
        "bias": {
          "type": "number",
          "description": "Mean signed difference (twin - real)"
        }
      }
    }
  }
}
