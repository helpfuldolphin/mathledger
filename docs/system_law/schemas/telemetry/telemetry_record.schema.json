{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/telemetry/telemetry_record.v1.0.0.json",
  "title": "Telemetry Record",
  "description": "Canonical telemetry record schema for Phase X I/O substrate. Each record represents a single telemetry emission from any system component (runner, verifier, governance layer). This is the primitive unit of the telemetry substrate.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "record_type",
    "record_id",
    "timestamp",
    "source",
    "payload"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "record_type": {
      "type": "string",
      "enum": [
        "runner_cycle",
        "verification_result",
        "governance_decision",
        "health_metric",
        "divergence_observation",
        "red_flag",
        "abstention",
        "block_seal",
        "calibration_event",
        "drift_alert"
      ],
      "description": "Type discriminator for payload interpretation"
    },
    "record_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
      "description": "UUID v4 unique identifier for this record"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp with timezone (UTC preferred). Format: YYYY-MM-DDTHH:mm:ss.SSSSSS+00:00"
    },
    "timestamp_monotonic_ns": {
      "type": "integer",
      "minimum": 0,
      "description": "Optional monotonic nanosecond counter for ordering within same second"
    },
    "source": {
      "type": "object",
      "required": ["component", "instance_id"],
      "properties": {
        "component": {
          "type": "string",
          "enum": [
            "u2_runner",
            "rfl_runner",
            "lean_verifier",
            "taut_verifier",
            "usla_bridge",
            "governance_layer",
            "first_light_shadow",
            "drift_radar",
            "health_monitor",
            "block_sealer"
          ],
          "description": "Source component emitting this telemetry"
        },
        "instance_id": {
          "type": "string",
          "description": "Instance identifier (run_id, session_id, or hostname)"
        },
        "slice_name": {
          "type": "string",
          "description": "Optional slice context (e.g., 'arithmetic_simple', 'propositional_depth_4')"
        },
        "mode": {
          "type": "string",
          "enum": ["PRODUCTION", "SHADOW", "TEST"],
          "default": "PRODUCTION",
          "description": "Execution mode context"
        }
      },
      "additionalProperties": false
    },
    "sequence": {
      "type": "object",
      "description": "Sequence tracking for ordering and gap detection",
      "properties": {
        "cycle": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycle number within current run"
        },
        "epoch": {
          "type": "integer",
          "minimum": 0,
          "description": "Epoch number for multi-epoch runs"
        },
        "global_seq": {
          "type": "integer",
          "minimum": 0,
          "description": "Global sequence number across all components"
        }
      },
      "additionalProperties": false
    },
    "payload": {
      "type": "object",
      "description": "Type-specific payload content. Schema varies by record_type.",
      "additionalProperties": true
    },
    "hash": {
      "type": "object",
      "description": "Cryptographic attestation for audit trail",
      "required": ["algorithm", "value"],
      "properties": {
        "algorithm": {
          "type": "string",
          "enum": ["sha256", "blake3"],
          "description": "Hash algorithm used"
        },
        "value": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "Hex-encoded hash of canonical payload serialization"
        },
        "payload_canonical": {
          "type": "string",
          "description": "Optional: JSON-canonicalized payload used for hashing"
        }
      },
      "additionalProperties": false
    },
    "correlation": {
      "type": "object",
      "description": "Cross-record correlation for tracing",
      "properties": {
        "parent_record_id": {
          "type": "string",
          "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
          "description": "UUID of parent/triggering record"
        },
        "trace_id": {
          "type": "string",
          "description": "Distributed trace identifier"
        },
        "span_id": {
          "type": "string",
          "description": "Span identifier within trace"
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "Extensible metadata for diagnostics",
      "additionalProperties": true
    }
  },
  "additionalProperties": false,
  "definitions": {
    "runner_cycle_payload": {
      "type": "object",
      "description": "Payload schema for record_type='runner_cycle'",
      "required": ["runner_type", "success", "duration_ms"],
      "properties": {
        "runner_type": {
          "type": "string",
          "enum": ["u2", "rfl"]
        },
        "success": {
          "type": "boolean"
        },
        "depth": {
          "type": "integer",
          "minimum": 0
        },
        "proof_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$"
        },
        "duration_ms": {
          "type": "number",
          "minimum": 0
        },
        "abstained": {
          "type": "boolean"
        },
        "abstention_reason": {
          "type": "string"
        },
        "usla_state": {
          "$ref": "#/definitions/usla_state"
        }
      }
    },
    "usla_state": {
      "type": "object",
      "description": "USLA state snapshot",
      "properties": {
        "H": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Health signal score"
        },
        "rho": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Running stability index"
        },
        "tau": {
          "type": "number",
          "minimum": 0,
          "description": "Current threshold"
        },
        "beta": {
          "type": "number",
          "minimum": 0,
          "description": "Block rate"
        },
        "in_omega": {
          "type": "boolean",
          "description": "Safe region membership"
        }
      }
    },
    "verification_result_payload": {
      "type": "object",
      "description": "Payload schema for record_type='verification_result'",
      "required": ["verification_id", "outcome", "duration_ms"],
      "properties": {
        "verification_id": {
          "type": "string"
        },
        "verifier_type": {
          "type": "string",
          "enum": ["lean", "taut", "z3"]
        },
        "outcome": {
          "type": "string",
          "enum": ["SUCCESS", "FAILURE", "TIMEOUT", "ERROR"]
        },
        "duration_ms": {
          "type": "number",
          "minimum": 0
        },
        "tier": {
          "type": "string",
          "enum": ["FAST", "BALANCED", "THOROUGH"]
        },
        "noise_injected": {
          "type": "boolean"
        },
        "ground_truth": {
          "type": "string",
          "enum": ["VERIFIED", "INVALID", "UNKNOWN"]
        }
      }
    },
    "governance_decision_payload": {
      "type": "object",
      "description": "Payload schema for record_type='governance_decision'",
      "required": ["decision", "governance_aligned"],
      "properties": {
        "decision": {
          "type": "string",
          "enum": ["PROCEED", "BLOCKED", "WARN", "ABSTAIN"]
        },
        "governance_aligned": {
          "type": "boolean"
        },
        "reasons": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "hard_ok": {
          "type": "boolean"
        }
      }
    }
  },
  "examples": [
    {
      "schema_version": "1.0.0",
      "record_type": "runner_cycle",
      "record_id": "550e8400-e29b-41d4-a716-446655440000",
      "timestamp": "2025-12-10T12:00:00.000000+00:00",
      "source": {
        "component": "u2_runner",
        "instance_id": "run_20251210_001",
        "slice_name": "arithmetic_simple",
        "mode": "PRODUCTION"
      },
      "sequence": {
        "cycle": 42,
        "epoch": 0,
        "global_seq": 12042
      },
      "payload": {
        "runner_type": "u2",
        "success": true,
        "depth": 4,
        "proof_hash": "abc123def456789...",
        "duration_ms": 142.5,
        "usla_state": {
          "H": 0.85,
          "rho": 0.92,
          "tau": 0.20,
          "beta": 0.05,
          "in_omega": true
        }
      },
      "hash": {
        "algorithm": "sha256",
        "value": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
      }
    }
  ]
}
