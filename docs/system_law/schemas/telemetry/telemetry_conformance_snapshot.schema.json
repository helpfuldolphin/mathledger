{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/telemetry/telemetry_conformance_snapshot.v1.0.0.json",
  "title": "Telemetry Conformance Snapshot",
  "description": "Schema for periodic conformance snapshots that capture telemetry system health, schema drift status, and governance alignment at a point in time. Used for drift detection, audit trails, and Phase X P4 coupling verification.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "snapshot_id",
    "timestamp",
    "conformance_status",
    "schema_registry",
    "emitter_health",
    "governance_alignment"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "snapshot_id": {
      "type": "string",
      "pattern": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
      "description": "UUID v4 unique identifier for this conformance snapshot"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when snapshot was generated"
    },
    "snapshot_epoch": {
      "type": "integer",
      "minimum": 0,
      "description": "Epoch number for this conformance check series"
    },
    "conformance_status": {
      "type": "object",
      "description": "Overall conformance status summary",
      "required": ["status", "drift_detected", "violations_count"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["CONFORMANT", "DRIFT_DETECTED", "VIOLATION", "DEGRADED"],
          "description": "Overall conformance status"
        },
        "drift_detected": {
          "type": "boolean",
          "description": "True if any schema or behavioral drift detected"
        },
        "violations_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of conformance violations detected"
        },
        "degraded_emitters": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of emitters in degraded state"
        },
        "last_conformant_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of last fully conformant snapshot"
        }
      },
      "additionalProperties": false
    },
    "schema_registry": {
      "type": "object",
      "description": "Registry of active telemetry schemas and their drift status",
      "required": ["schemas", "drift_report"],
      "properties": {
        "schemas": {
          "type": "array",
          "description": "List of registered schemas",
          "items": {
            "type": "object",
            "required": ["schema_id", "version", "status"],
            "properties": {
              "schema_id": {
                "type": "string",
                "description": "Schema identifier (e.g., 'telemetry_record', 'p4_divergence_log')"
              },
              "version": {
                "type": "string",
                "pattern": "^\\d+\\.\\d+\\.\\d+$",
                "description": "Semantic version of schema"
              },
              "status": {
                "type": "string",
                "enum": ["ACTIVE", "DEPRECATED", "DRAFT"],
                "description": "Schema lifecycle status"
              },
              "hash": {
                "type": "string",
                "pattern": "^sha256:[a-f0-9]{64}$",
                "description": "SHA-256 hash of canonical schema content"
              },
              "last_validated": {
                "type": "string",
                "format": "date-time",
                "description": "Last validation timestamp"
              }
            },
            "additionalProperties": false
          }
        },
        "drift_report": {
          "type": "object",
          "description": "Schema drift detection results",
          "properties": {
            "baseline_hash": {
              "type": "string",
              "pattern": "^sha256:[a-f0-9]{64}$",
              "description": "Hash of baseline schema set"
            },
            "current_hash": {
              "type": "string",
              "pattern": "^sha256:[a-f0-9]{64}$",
              "description": "Hash of current schema set"
            },
            "drift_detected": {
              "type": "boolean",
              "description": "True if hashes differ"
            },
            "drifted_schemas": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "List of schema IDs that have drifted"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "emitter_health": {
      "type": "object",
      "description": "Health status of telemetry emitters",
      "required": ["emitters", "total_healthy", "total_degraded"],
      "properties": {
        "emitters": {
          "type": "array",
          "description": "Per-emitter health status",
          "items": {
            "type": "object",
            "required": ["component", "status", "last_emit"],
            "properties": {
              "component": {
                "type": "string",
                "description": "Component name (matches source.component in telemetry_record)"
              },
              "status": {
                "type": "string",
                "enum": ["HEALTHY", "DEGRADED", "SILENT", "ERROR"],
                "description": "Emitter health status"
              },
              "last_emit": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp of last telemetry emission"
              },
              "emit_rate_per_minute": {
                "type": "number",
                "minimum": 0,
                "description": "Recent emission rate"
              },
              "error_rate": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "Fraction of emissions with errors"
              },
              "schema_violations": {
                "type": "integer",
                "minimum": 0,
                "description": "Number of schema validation failures"
              },
              "instance_count": {
                "type": "integer",
                "minimum": 0,
                "description": "Number of active instances"
              }
            },
            "additionalProperties": false
          }
        },
        "total_healthy": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of healthy emitters"
        },
        "total_degraded": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of degraded emitters"
        },
        "total_silent": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of silent emitters (no recent emissions)"
        }
      },
      "additionalProperties": false
    },
    "governance_alignment": {
      "type": "object",
      "description": "Telemetry alignment with governance requirements",
      "required": ["aligned", "alignment_score"],
      "properties": {
        "aligned": {
          "type": "boolean",
          "description": "True if telemetry fully supports governance requirements"
        },
        "alignment_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Quantified alignment score (1.0 = fully aligned)"
        },
        "required_record_types": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Record types required for governance"
        },
        "missing_record_types": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Required record types not being emitted"
        },
        "p4_coupling_ready": {
          "type": "boolean",
          "description": "True if telemetry substrate supports P4 real coupling"
        },
        "tda_feedback_enabled": {
          "type": "boolean",
          "description": "True if TDA feedback from telemetry anomalies is enabled"
        },
        "shadow_mode_active": {
          "type": "boolean",
          "description": "True if shadow mode observation is active"
        }
      },
      "additionalProperties": false
    },
    "audit_trail": {
      "type": "object",
      "description": "Cryptographic audit trail for this snapshot",
      "properties": {
        "snapshot_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA-256 hash of this snapshot (excluding this field)"
        },
        "previous_snapshot_hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "Hash of previous conformance snapshot (chain linkage)"
        },
        "attestation_chain_length": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of snapshots in attestation chain"
        }
      },
      "additionalProperties": false
    },
    "p4_coupling_status": {
      "type": "object",
      "description": "Status of Phase X P4 real coupling (SHADOW MODE)",
      "properties": {
        "coupling_active": {
          "type": "boolean",
          "description": "True if P4 coupling is active"
        },
        "adapter_type": {
          "type": "string",
          "enum": ["USLAIntegrationAdapter", "MockTelemetryProvider", "None"],
          "description": "Active telemetry adapter type"
        },
        "snapshots_captured": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of telemetry snapshots captured this epoch"
        },
        "divergences_observed": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of real vs twin divergences observed"
        },
        "mode": {
          "type": "string",
          "const": "SHADOW",
          "description": "Must always be SHADOW in P4"
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "Extensible metadata",
      "additionalProperties": true
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "snapshot_id": "550e8400-e29b-41d4-a716-446655440001",
      "timestamp": "2025-12-10T12:00:00.000000+00:00",
      "snapshot_epoch": 42,
      "conformance_status": {
        "status": "CONFORMANT",
        "drift_detected": false,
        "violations_count": 0,
        "degraded_emitters": 0,
        "last_conformant_timestamp": "2025-12-10T12:00:00.000000+00:00"
      },
      "schema_registry": {
        "schemas": [
          {
            "schema_id": "telemetry_record",
            "version": "1.0.0",
            "status": "ACTIVE",
            "hash": "sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
            "last_validated": "2025-12-10T12:00:00.000000+00:00"
          }
        ],
        "drift_report": {
          "baseline_hash": "sha256:abc123...",
          "current_hash": "sha256:abc123...",
          "drift_detected": false,
          "drifted_schemas": []
        }
      },
      "emitter_health": {
        "emitters": [
          {
            "component": "u2_runner",
            "status": "HEALTHY",
            "last_emit": "2025-12-10T11:59:59.000000+00:00",
            "emit_rate_per_minute": 12.5,
            "error_rate": 0.0,
            "schema_violations": 0,
            "instance_count": 1
          }
        ],
        "total_healthy": 5,
        "total_degraded": 0,
        "total_silent": 0
      },
      "governance_alignment": {
        "aligned": true,
        "alignment_score": 1.0,
        "required_record_types": ["runner_cycle", "verification_result", "governance_decision"],
        "missing_record_types": [],
        "p4_coupling_ready": true,
        "tda_feedback_enabled": true,
        "shadow_mode_active": true
      },
      "audit_trail": {
        "snapshot_hash": "sha256:def456...",
        "previous_snapshot_hash": "sha256:abc123...",
        "attestation_chain_length": 42
      },
      "p4_coupling_status": {
        "coupling_active": true,
        "adapter_type": "USLAIntegrationAdapter",
        "snapshots_captured": 1000,
        "divergences_observed": 15,
        "mode": "SHADOW"
      }
    }
  ]
}
