{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/tda/tda_metrics_p3.v1.0.0.json",
  "title": "TDA Metrics P3 Stability Envelope",
  "description": "Schema for TDA (Topological Data Analysis) metrics in P3 First-Light stability envelopes. SHADOW MODE: observational only, no governance modification.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "window_index",
    "timestamp",
    "mode",
    "sns",
    "pcs",
    "hss",
    "envelope"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "window_index": {
      "type": "integer",
      "minimum": 0,
      "description": "Observation window index (0-indexed)"
    },
    "window_start_cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "First cycle in this window"
    },
    "window_end_cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "Last cycle in this window (inclusive)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of window completion"
    },
    "mode": {
      "type": "string",
      "const": "SHADOW",
      "description": "Execution mode - always SHADOW in P3"
    },
    "sns": {
      "type": "object",
      "description": "Structural Novelty Score metrics for this window",
      "required": ["mean", "max", "min", "std"],
      "properties": {
        "mean": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Mean SNS over window cycles"
        },
        "max": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Maximum SNS observed in window"
        },
        "min": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum SNS observed in window"
        },
        "std": {
          "type": "number",
          "minimum": 0,
          "description": "Standard deviation of SNS in window"
        },
        "anomaly_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with SNS > 0.6 (CRITICAL threshold)"
        },
        "elevated_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with SNS > 0.4 (WARN threshold)"
        },
        "trajectory": {
          "type": "array",
          "items": {"type": "number", "minimum": 0, "maximum": 1},
          "description": "Per-cycle SNS values in window (optional)"
        }
      }
    },
    "pcs": {
      "type": "object",
      "description": "Proof Coherence Score metrics for this window",
      "required": ["mean", "max", "min", "std"],
      "properties": {
        "mean": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Mean PCS over window cycles"
        },
        "max": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Maximum PCS observed in window"
        },
        "min": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum PCS observed in window"
        },
        "std": {
          "type": "number",
          "minimum": 0,
          "description": "Standard deviation of PCS in window"
        },
        "low_coherence_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with PCS < 0.6 (WARN threshold)"
        },
        "incoherent_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with PCS < 0.4 (CRITICAL threshold)"
        },
        "trajectory": {
          "type": "array",
          "items": {"type": "number", "minimum": 0, "maximum": 1},
          "description": "Per-cycle PCS values in window (optional)"
        }
      }
    },
    "hss": {
      "type": "object",
      "description": "Homological Stability Score metrics for this window",
      "required": ["mean", "max", "min", "std"],
      "properties": {
        "mean": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Mean HSS over window cycles"
        },
        "max": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Maximum HSS observed in window"
        },
        "min": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Minimum HSS observed in window"
        },
        "std": {
          "type": "number",
          "minimum": 0,
          "description": "Standard deviation of HSS in window"
        },
        "degradation_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with HSS < 0.4 (CRITICAL threshold)"
        },
        "unstable_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of cycles with HSS < 0.6 (WARN threshold)"
        },
        "betti_snapshot": {
          "type": "object",
          "description": "Betti numbers at window end",
          "properties": {
            "b0": {"type": "integer", "minimum": 0, "description": "Connected components"},
            "b1": {"type": "integer", "minimum": 0, "description": "1-dimensional holes"},
            "b2": {"type": "integer", "minimum": 0, "description": "2-dimensional voids"}
          }
        },
        "trajectory": {
          "type": "array",
          "items": {"type": "number", "minimum": 0, "maximum": 1},
          "description": "Per-cycle HSS values in window (optional)"
        }
      }
    },
    "envelope": {
      "type": "object",
      "description": "TDA stability envelope (Omega_TDA) metrics",
      "required": ["occupancy_rate", "exit_count"],
      "properties": {
        "occupancy_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Fraction of cycles in Omega_TDA envelope"
        },
        "exit_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of envelope exit events in window"
        },
        "max_exit_streak": {
          "type": "integer",
          "minimum": 0,
          "description": "Longest consecutive exit streak in window"
        },
        "envelope_definition": {
          "type": "object",
          "description": "Thresholds defining Omega_TDA",
          "properties": {
            "sns_max": {"type": "number", "default": 0.4},
            "pcs_min": {"type": "number", "default": 0.6},
            "hss_min": {"type": "number", "default": 0.6}
          }
        }
      }
    },
    "red_flags": {
      "type": "object",
      "description": "TDA-related red-flag observations (LOGGED ONLY)",
      "properties": {
        "tda_sns_anomaly": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of TDA_SNS_ANOMALY red-flags"
        },
        "tda_pcs_collapse": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of TDA_PCS_COLLAPSE red-flags"
        },
        "tda_hss_degradation": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of TDA_HSS_DEGRADATION red-flags"
        },
        "tda_envelope_exit": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of TDA_ENVELOPE_EXIT red-flags"
        }
      }
    },
    "cumulative": {
      "type": "object",
      "description": "Cumulative TDA metrics from run start to this window",
      "properties": {
        "sns_cumulative_mean": {"type": "number", "minimum": 0, "maximum": 1},
        "pcs_cumulative_mean": {"type": "number", "minimum": 0, "maximum": 1},
        "hss_cumulative_mean": {"type": "number", "minimum": 0, "maximum": 1},
        "envelope_cumulative_occupancy": {"type": "number", "minimum": 0, "maximum": 1},
        "total_anomalies": {"type": "integer", "minimum": 0}
      }
    }
  },
  "additionalProperties": false
}
