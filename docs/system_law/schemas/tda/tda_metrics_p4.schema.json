{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/tda/tda_metrics_p4.v1.0.0.json",
  "title": "TDA Metrics P4 Divergence Context",
  "description": "Schema for TDA (Topological Data Analysis) metrics in P4 divergence logs. Provides DRS-based drift analysis and TDA context for real vs twin divergence. SHADOW MODE: observational only, no governance modification.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "cycle",
    "timestamp",
    "mode",
    "drs",
    "tda_state"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "cycle": {
      "type": "integer",
      "minimum": 1,
      "description": "Cycle index (1-indexed)"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO8601 timestamp of observation"
    },
    "mode": {
      "type": "string",
      "const": "SHADOW",
      "description": "Execution mode - always SHADOW in P4"
    },
    "drs": {
      "type": "object",
      "description": "Drift Rate Score computation",
      "required": ["value", "severity"],
      "properties": {
        "value": {
          "type": "number",
          "minimum": 0,
          "description": "DRS value: L2 norm of state drift per cycle"
        },
        "severity": {
          "type": "string",
          "enum": ["NONE", "INFO", "WARN", "CRITICAL"],
          "description": "Severity classification based on DRS thresholds"
        },
        "components": {
          "type": "object",
          "description": "Per-dimension drift components",
          "properties": {
            "H_drift": {
              "type": "number",
              "description": "Absolute drift in H (health) dimension"
            },
            "rho_drift": {
              "type": "number",
              "description": "Absolute drift in rho (RSI) dimension"
            },
            "tau_drift": {
              "type": "number",
              "description": "Absolute drift in tau (threshold) dimension"
            },
            "beta_drift": {
              "type": "number",
              "description": "Absolute drift in beta (block rate) dimension"
            }
          }
        },
        "streak": {
          "type": "object",
          "description": "Consecutive divergence streak tracking",
          "properties": {
            "current_length": {
              "type": "integer",
              "minimum": 0,
              "description": "Current consecutive cycles with DRS above threshold"
            },
            "streak_start_cycle": {
              "type": ["integer", "null"],
              "description": "Cycle where current streak began"
            },
            "escalated_severity": {
              "type": "string",
              "enum": ["NONE", "INFO", "WARN", "CRITICAL"],
              "description": "Severity after streak-based escalation"
            }
          }
        },
        "thresholds": {
          "type": "object",
          "description": "Active DRS severity thresholds",
          "properties": {
            "info": {"type": "number", "default": 0.05},
            "warn": {"type": "number", "default": 0.10},
            "critical": {"type": "number", "default": 0.20}
          }
        }
      }
    },
    "tda_state": {
      "type": "object",
      "description": "TDA metrics at this cycle (real runner observed)",
      "properties": {
        "sns": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Structural Novelty Score at this cycle"
        },
        "pcs": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Proof Coherence Score at this cycle"
        },
        "hss": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Homological Stability Score at this cycle"
        },
        "in_tda_envelope": {
          "type": "boolean",
          "description": "Whether current state is in Omega_TDA envelope"
        }
      }
    },
    "twin_tda_prediction": {
      "type": "object",
      "description": "TDA metrics predicted by shadow twin",
      "properties": {
        "predicted_sns": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Twin-predicted SNS for this cycle"
        },
        "predicted_pcs": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Twin-predicted PCS for this cycle"
        },
        "predicted_hss": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Twin-predicted HSS for this cycle"
        },
        "predicted_in_envelope": {
          "type": "boolean",
          "description": "Twin-predicted envelope membership"
        }
      }
    },
    "tda_divergence": {
      "type": "object",
      "description": "Divergence between real TDA state and twin prediction",
      "properties": {
        "sns_delta": {
          "type": "number",
          "description": "Absolute difference: |real_SNS - twin_SNS|"
        },
        "pcs_delta": {
          "type": "number",
          "description": "Absolute difference: |real_PCS - twin_PCS|"
        },
        "hss_delta": {
          "type": "number",
          "description": "Absolute difference: |real_HSS - twin_HSS|"
        },
        "envelope_mismatch": {
          "type": "boolean",
          "description": "True if real and twin disagree on envelope membership"
        },
        "tda_divergence_score": {
          "type": "number",
          "minimum": 0,
          "description": "Composite TDA divergence: sqrt(sns_delta^2 + pcs_delta^2 + hss_delta^2)"
        }
      }
    },
    "real_usla_state": {
      "type": "object",
      "description": "Real runner USLA state at this cycle",
      "properties": {
        "H": {"type": "number", "minimum": 0, "maximum": 1},
        "rho": {"type": "number", "minimum": 0, "maximum": 1},
        "tau": {"type": "number", "minimum": 0, "maximum": 1},
        "beta": {"type": "number", "minimum": 0, "maximum": 1},
        "in_omega": {"type": "boolean"},
        "success": {"type": "boolean"},
        "blocked": {"type": "boolean"}
      }
    },
    "twin_usla_state": {
      "type": "object",
      "description": "Twin predicted USLA state at this cycle",
      "properties": {
        "H": {"type": "number", "minimum": 0, "maximum": 1},
        "rho": {"type": "number", "minimum": 0, "maximum": 1},
        "tau": {"type": "number", "minimum": 0, "maximum": 1},
        "beta": {"type": "number", "minimum": 0, "maximum": 1},
        "in_omega": {"type": "boolean"},
        "predicted_success": {"type": "boolean"},
        "predicted_blocked": {"type": "boolean"}
      }
    },
    "outcome_divergence": {
      "type": "object",
      "description": "Binary outcome divergences",
      "properties": {
        "success_mismatch": {
          "type": "boolean",
          "description": "Real success != twin predicted success"
        },
        "blocked_mismatch": {
          "type": "boolean",
          "description": "Real blocked != twin predicted blocked"
        },
        "omega_mismatch": {
          "type": "boolean",
          "description": "Real in_omega != twin predicted in_omega"
        },
        "hard_ok_mismatch": {
          "type": "boolean",
          "description": "Real hard_ok != twin predicted hard_ok"
        }
      }
    },
    "action": {
      "type": "string",
      "const": "LOGGED_ONLY",
      "description": "Action taken - always LOGGED_ONLY in SHADOW mode"
    },
    "hypothetical_intervention": {
      "type": "object",
      "description": "What intervention WOULD have been triggered (analysis only)",
      "properties": {
        "would_intervene": {
          "type": "boolean",
          "description": "Whether intervention threshold was met"
        },
        "intervention_type": {
          "type": ["string", "null"],
          "enum": ["NONE", "ALERT", "THROTTLE", "ABORT", null],
          "description": "Type of intervention that would have been triggered"
        },
        "trigger_reason": {
          "type": ["string", "null"],
          "description": "Reason for hypothetical intervention"
        }
      }
    },
    "telemetry_hash": {
      "type": "string",
      "pattern": "^sha256:[a-f0-9]{64}$",
      "description": "SHA-256 hash of source telemetry for audit trail"
    }
  },
  "additionalProperties": false
}
