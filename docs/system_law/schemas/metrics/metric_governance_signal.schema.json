{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/metrics/governance_signal.v1.0.0.json",
  "title": "Metric Governance Signal",
  "description": "Schema for the unified Metric Governance Signal that synthesizes drift compass, budget view, and FO vital signs into a single normalized governance decision. This is the canonical input vector for Phase X governance gates.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "signal_type",
    "timestamp",
    "mode",
    "governance_status",
    "governance_alignment",
    "sub_signals",
    "safe_for_policy_update",
    "safe_for_promotion"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "signal_type": {
      "type": "string",
      "const": "metric_governance_signal",
      "description": "Signal type identifier"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when signal was synthesized"
    },
    "mode": {
      "type": "string",
      "enum": ["SHADOW", "ACTIVE"],
      "description": "Operational mode. P3/P4 must use SHADOW. ACTIVE reserved for P5+."
    },
    "phase": {
      "type": "string",
      "enum": ["P3", "P4", "P5"],
      "description": "Phase X phase identifier"
    },
    "run_id": {
      "type": "string",
      "description": "Optional run identifier for traceability"
    },
    "cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "Cycle index if applicable"
    },
    "governance_status": {
      "type": "string",
      "enum": ["OK", "WARN", "BLOCK"],
      "description": "Final synthesized governance status"
    },
    "governance_alignment": {
      "type": "string",
      "enum": ["ALIGNED", "TENSION", "DIVERGENT"],
      "description": "Alignment state across all sub-signals"
    },
    "sub_signals": {
      "type": "object",
      "description": "Individual sub-signal statuses that contribute to final decision",
      "required": ["drift_compass", "budget_view", "fo_vital_signs"],
      "properties": {
        "drift_compass": {
          "type": "object",
          "required": ["status", "compass_heading", "drift_magnitude"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["OK", "WARN", "BLOCK"],
              "description": "Drift compass contribution status"
            },
            "compass_heading": {
              "type": "string",
              "enum": ["STABLE", "DRIFTING", "DIVERGING", "CRITICAL"],
              "description": "Current compass heading"
            },
            "drift_magnitude": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Current drift magnitude"
            },
            "poly_cause_detected": {
              "type": "boolean",
              "description": "Whether poly-cause drift is detected"
            }
          }
        },
        "budget_view": {
          "type": "object",
          "required": ["status", "budget_status", "utilization_pct"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["OK", "WARN", "BLOCK"],
              "description": "Budget view contribution status"
            },
            "budget_status": {
              "type": "string",
              "enum": ["UNDER", "NOMINAL", "ELEVATED", "CRITICAL", "EXCEEDED"],
              "description": "Current budget status"
            },
            "utilization_pct": {
              "type": "number",
              "minimum": 0,
              "description": "Current utilization percentage"
            },
            "blocking_resources": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Resources currently blocking"
            }
          }
        },
        "fo_vital_signs": {
          "type": "object",
          "required": ["status", "health_status", "success_rate"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["OK", "WARN", "BLOCK"],
              "description": "FO vital signs contribution status"
            },
            "health_status": {
              "type": "string",
              "enum": ["ALIVE", "DEGRADED", "CRITICAL", "UNKNOWN"],
              "description": "FO health status"
            },
            "success_rate": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "FO success rate (0-100%)"
            },
            "should_throttle": {
              "type": "boolean",
              "description": "FO throttle recommendation"
            },
            "should_boost": {
              "type": "boolean",
              "description": "FO boost recommendation"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "FO signal confidence"
            }
          }
        },
        "divergence_classifier": {
          "type": "object",
          "description": "P4 divergence classifier integration (optional, P4 only)",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["OK", "WARN", "BLOCK"],
              "description": "Divergence classifier contribution status"
            },
            "severity": {
              "type": "string",
              "enum": ["NONE", "MINOR", "MODERATE", "SEVERE"],
              "description": "Divergence severity from P4 analysis"
            },
            "streak_length": {
              "type": "integer",
              "minimum": 0,
              "description": "Current divergence streak"
            },
            "twin_correlation": {
              "type": "boolean",
              "description": "Whether correlated with twin prediction"
            }
          }
        }
      }
    },
    "conflict_matrix": {
      "type": "object",
      "description": "Pairwise conflict detection between sub-signals",
      "properties": {
        "drift_vs_budget": {
          "type": "string",
          "enum": ["ALIGNED", "TENSION", "CONFLICT"],
          "description": "Drift compass vs budget view alignment"
        },
        "drift_vs_fo": {
          "type": "string",
          "enum": ["ALIGNED", "TENSION", "CONFLICT"],
          "description": "Drift compass vs FO vital signs alignment"
        },
        "budget_vs_fo": {
          "type": "string",
          "enum": ["ALIGNED", "TENSION", "CONFLICT"],
          "description": "Budget view vs FO vital signs alignment"
        },
        "any_conflict": {
          "type": "boolean",
          "description": "True if any pairwise conflict exists"
        }
      }
    },
    "reasons": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^\\[(DriftCompass|BudgetView|FOVitalSigns|DivergenceClassifier|CONFLICT|SYNTHESIS)\\].*",
        "description": "Reason string prefixed with source tag"
      },
      "description": "List of prefixed diagnostic reasons from all sub-signals"
    },
    "safe_for_policy_update": {
      "type": "boolean",
      "description": "Whether the system state is safe for policy updates"
    },
    "safe_for_promotion": {
      "type": "boolean",
      "description": "Whether the current state is eligible for promotion"
    },
    "recommended_action": {
      "type": "string",
      "enum": ["CONTINUE", "MONITOR", "THROTTLE", "INVESTIGATE", "HALT"],
      "description": "Synthesized recommended action"
    },
    "intensity_multiplier": {
      "type": "number",
      "minimum": 0,
      "maximum": 2,
      "description": "Synthesized intensity multiplier for RFL runner"
    },
    "governance_layer_outputs": {
      "type": "object",
      "description": "Cross-layer governance integration",
      "properties": {
        "layer": {
          "type": "string",
          "const": "metrics",
          "description": "Governance layer identifier"
        },
        "feeds_into": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Downstream layers this signal feeds into"
        },
        "upstream_dependencies": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Upstream layers this signal depends on"
        }
      }
    },
    "audit_trail": {
      "type": "object",
      "description": "Cryptographic audit trail for signal",
      "properties": {
        "signal_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hash of signal content"
        },
        "drift_compass_hash": {
          "type": "string",
          "description": "Hash of drift compass input"
        },
        "budget_view_hash": {
          "type": "string",
          "description": "Hash of budget view input"
        },
        "fo_vital_signs_hash": {
          "type": "string",
          "description": "Hash of FO vital signs input"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional extended metadata",
      "properties": {
        "synthesis_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Time taken to synthesize signal"
        },
        "schema_validation_passed": {
          "type": "boolean",
          "description": "Whether all input schemas validated"
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_governance_signal",
      "timestamp": "2025-12-10T00:00:00Z",
      "mode": "SHADOW",
      "phase": "P4",
      "run_id": "p4-run-001",
      "cycle": 42,
      "governance_status": "OK",
      "governance_alignment": "ALIGNED",
      "sub_signals": {
        "drift_compass": {
          "status": "OK",
          "compass_heading": "STABLE",
          "drift_magnitude": 0.12,
          "poly_cause_detected": false
        },
        "budget_view": {
          "status": "OK",
          "budget_status": "NOMINAL",
          "utilization_pct": 65.5,
          "blocking_resources": []
        },
        "fo_vital_signs": {
          "status": "OK",
          "health_status": "ALIVE",
          "success_rate": 95.0,
          "should_throttle": false,
          "should_boost": false,
          "confidence": 1.0
        },
        "divergence_classifier": {
          "status": "OK",
          "severity": "NONE",
          "streak_length": 0,
          "twin_correlation": true
        }
      },
      "conflict_matrix": {
        "drift_vs_budget": "ALIGNED",
        "drift_vs_fo": "ALIGNED",
        "budget_vs_fo": "ALIGNED",
        "any_conflict": false
      },
      "reasons": [
        "[DriftCompass] Compass heading STABLE, magnitude 0.12",
        "[BudgetView] Utilization nominal at 65.5%",
        "[FOVitalSigns] Health ALIVE, success rate 95.0%",
        "[SYNTHESIS] All sub-signals aligned - OK"
      ],
      "safe_for_policy_update": true,
      "safe_for_promotion": true,
      "recommended_action": "CONTINUE",
      "intensity_multiplier": 1.0,
      "governance_layer_outputs": {
        "layer": "metrics",
        "feeds_into": ["governance", "admissibility"],
        "upstream_dependencies": ["replay", "topology"]
      }
    },
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_governance_signal",
      "timestamp": "2025-12-10T01:00:00Z",
      "mode": "SHADOW",
      "phase": "P3",
      "governance_status": "WARN",
      "governance_alignment": "TENSION",
      "sub_signals": {
        "drift_compass": {
          "status": "WARN",
          "compass_heading": "DRIFTING",
          "drift_magnitude": 0.45,
          "poly_cause_detected": true
        },
        "budget_view": {
          "status": "OK",
          "budget_status": "NOMINAL",
          "utilization_pct": 70.0,
          "blocking_resources": []
        },
        "fo_vital_signs": {
          "status": "WARN",
          "health_status": "DEGRADED",
          "success_rate": 72.0,
          "should_throttle": true,
          "should_boost": false,
          "confidence": 0.7
        }
      },
      "conflict_matrix": {
        "drift_vs_budget": "TENSION",
        "drift_vs_fo": "ALIGNED",
        "budget_vs_fo": "TENSION",
        "any_conflict": false
      },
      "reasons": [
        "[DriftCompass] Poly-cause drift detected across 2 axes",
        "[BudgetView] Utilization nominal but approaching elevated",
        "[FOVitalSigns] Health DEGRADED, throttle recommended",
        "[SYNTHESIS] Tension between budget and drift/FO signals"
      ],
      "safe_for_policy_update": true,
      "safe_for_promotion": false,
      "recommended_action": "THROTTLE",
      "intensity_multiplier": 0.5
    },
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_governance_signal",
      "timestamp": "2025-12-10T02:00:00Z",
      "mode": "SHADOW",
      "phase": "P4",
      "governance_status": "BLOCK",
      "governance_alignment": "DIVERGENT",
      "sub_signals": {
        "drift_compass": {
          "status": "BLOCK",
          "compass_heading": "CRITICAL",
          "drift_magnitude": 0.85,
          "poly_cause_detected": true
        },
        "budget_view": {
          "status": "BLOCK",
          "budget_status": "EXCEEDED",
          "utilization_pct": 105.0,
          "blocking_resources": ["derivation_steps"]
        },
        "fo_vital_signs": {
          "status": "BLOCK",
          "health_status": "CRITICAL",
          "success_rate": 35.0,
          "should_throttle": true,
          "should_boost": false,
          "confidence": 1.0
        },
        "divergence_classifier": {
          "status": "WARN",
          "severity": "MODERATE",
          "streak_length": 5,
          "twin_correlation": false
        }
      },
      "conflict_matrix": {
        "drift_vs_budget": "ALIGNED",
        "drift_vs_fo": "ALIGNED",
        "budget_vs_fo": "ALIGNED",
        "any_conflict": false
      },
      "reasons": [
        "[DriftCompass] CRITICAL heading - multi-axis collapse",
        "[BudgetView] Budget EXCEEDED - derivation_steps exhausted",
        "[FOVitalSigns] CRITICAL health - success rate 35%",
        "[DivergenceClassifier] MODERATE divergence, streak 5, twin uncorrelated",
        "[SYNTHESIS] Multiple BLOCK signals - system halt recommended"
      ],
      "safe_for_policy_update": false,
      "safe_for_promotion": false,
      "recommended_action": "HALT",
      "intensity_multiplier": 0.0
    }
  ]
}
