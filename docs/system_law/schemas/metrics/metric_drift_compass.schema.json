{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/metrics/drift_compass.v1.0.0.json",
  "title": "Metric Drift Compass",
  "description": "Schema for multi-axis metric drift tracking. Provides a normalized compass view across all instrumented metrics for P3 (synthetic) and P4 (shadow coupling) phases. SHADOW MODE: observation-only.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "signal_type",
    "timestamp",
    "mode",
    "compass_heading",
    "drift_magnitude",
    "axes"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "signal_type": {
      "type": "string",
      "const": "metric_drift_compass",
      "description": "Signal type identifier"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when compass reading was computed"
    },
    "mode": {
      "type": "string",
      "enum": ["SHADOW", "ACTIVE"],
      "description": "Operational mode. P3/P4 must use SHADOW. ACTIVE reserved for future phases."
    },
    "phase": {
      "type": "string",
      "enum": ["P3", "P4", "P5"],
      "description": "Phase X phase identifier"
    },
    "run_id": {
      "type": "string",
      "description": "Optional run identifier for traceability"
    },
    "cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "Cycle index if applicable"
    },
    "compass_heading": {
      "type": "string",
      "enum": ["STABLE", "DRIFTING", "DIVERGING", "CRITICAL"],
      "description": "Normalized compass heading based on drift magnitude and axis count"
    },
    "drift_magnitude": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Normalized drift magnitude (0 = no drift, 1 = maximum drift)"
    },
    "drift_velocity": {
      "type": "number",
      "description": "Rate of change of drift magnitude per cycle"
    },
    "axes": {
      "type": "array",
      "description": "Per-axis drift measurements",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["axis_name", "drift_value", "threshold", "status"],
        "properties": {
          "axis_name": {
            "type": "string",
            "description": "Metric axis identifier (e.g., 'success_rate', 'rsi', 'abstention', 'duration')"
          },
          "drift_value": {
            "type": "number",
            "description": "Current drift value for this axis"
          },
          "threshold": {
            "type": "number",
            "description": "Threshold at which this axis triggers warning"
          },
          "critical_threshold": {
            "type": "number",
            "description": "Threshold at which this axis triggers critical alert"
          },
          "status": {
            "type": "string",
            "enum": ["OK", "WARN", "CRITICAL"],
            "description": "Status of this axis"
          },
          "direction": {
            "type": "string",
            "enum": ["up", "down", "flat"],
            "description": "Drift direction for this axis"
          },
          "contribution": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "This axis's contribution to total drift magnitude"
          }
        }
      }
    },
    "poly_cause_detected": {
      "type": "boolean",
      "description": "True if multiple axes are drifting simultaneously (indicates systemic issue)"
    },
    "poly_cause_axes": {
      "type": "array",
      "items": {"type": "string"},
      "description": "List of axis names contributing to poly-cause drift"
    },
    "governance_implication": {
      "type": "object",
      "description": "Governance signal implications (P4 divergence-classifier integration)",
      "properties": {
        "safe_for_promotion": {
          "type": "boolean",
          "description": "Whether current drift state allows promotion"
        },
        "requires_attention": {
          "type": "boolean",
          "description": "Whether drift state requires operator attention"
        },
        "recommended_action": {
          "type": "string",
          "enum": ["CONTINUE", "MONITOR", "INVESTIGATE", "HALT"],
          "description": "Recommended action based on drift state"
        }
      }
    },
    "fo_correlation": {
      "type": "object",
      "description": "Correlation with First Organism vital signs",
      "properties": {
        "health_status": {
          "type": "string",
          "enum": ["ALIVE", "DEGRADED", "CRITICAL", "UNKNOWN"],
          "description": "Corresponding FO health status"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "FO success rate at compass reading"
        },
        "signal_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{16}$",
          "description": "FO feedback signal hash for audit trail"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional extended metadata",
      "properties": {
        "computation_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Time taken to compute compass reading"
        },
        "source_metrics_hash": {
          "type": "string",
          "description": "SHA-256 hash of source metrics for reproducibility"
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_drift_compass",
      "timestamp": "2025-12-10T00:00:00Z",
      "mode": "SHADOW",
      "phase": "P4",
      "run_id": "p4-run-001",
      "cycle": 42,
      "compass_heading": "STABLE",
      "drift_magnitude": 0.12,
      "drift_velocity": 0.002,
      "axes": [
        {
          "axis_name": "success_rate",
          "drift_value": 0.05,
          "threshold": 0.1,
          "critical_threshold": 0.2,
          "status": "OK",
          "direction": "flat",
          "contribution": 0.42
        },
        {
          "axis_name": "rsi",
          "drift_value": 0.07,
          "threshold": 0.15,
          "critical_threshold": 0.3,
          "status": "OK",
          "direction": "up",
          "contribution": 0.58
        }
      ],
      "poly_cause_detected": false,
      "poly_cause_axes": [],
      "governance_implication": {
        "safe_for_promotion": true,
        "requires_attention": false,
        "recommended_action": "CONTINUE"
      },
      "fo_correlation": {
        "health_status": "ALIVE",
        "success_rate": 95.0,
        "signal_hash": "a1b2c3d4e5f67890"
      }
    },
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_drift_compass",
      "timestamp": "2025-12-10T01:00:00Z",
      "mode": "SHADOW",
      "phase": "P3",
      "compass_heading": "DIVERGING",
      "drift_magnitude": 0.65,
      "drift_velocity": 0.05,
      "axes": [
        {
          "axis_name": "success_rate",
          "drift_value": 0.25,
          "threshold": 0.1,
          "critical_threshold": 0.2,
          "status": "CRITICAL",
          "direction": "down",
          "contribution": 0.38
        },
        {
          "axis_name": "abstention",
          "drift_value": 0.20,
          "threshold": 0.15,
          "critical_threshold": 0.25,
          "status": "WARN",
          "direction": "up",
          "contribution": 0.31
        },
        {
          "axis_name": "duration",
          "drift_value": 0.20,
          "threshold": 0.2,
          "critical_threshold": 0.4,
          "status": "OK",
          "direction": "up",
          "contribution": 0.31
        }
      ],
      "poly_cause_detected": true,
      "poly_cause_axes": ["success_rate", "abstention"],
      "governance_implication": {
        "safe_for_promotion": false,
        "requires_attention": true,
        "recommended_action": "INVESTIGATE"
      }
    }
  ]
}
