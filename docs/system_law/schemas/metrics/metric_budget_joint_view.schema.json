{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/metrics/budget_joint_view.v1.0.0.json",
  "title": "Metric Budget Joint View",
  "description": "Schema for joint metric budget tracking across governance layers. Provides a unified view of metric consumption vs. allocation for resource-constrained operations during P3 (synthetic) and P4 (shadow coupling) phases.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "signal_type",
    "timestamp",
    "mode",
    "budget_status",
    "utilization_pct",
    "allocations"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "signal_type": {
      "type": "string",
      "const": "metric_budget_joint_view",
      "description": "Signal type identifier"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when budget snapshot was computed"
    },
    "mode": {
      "type": "string",
      "enum": ["SHADOW", "ACTIVE"],
      "description": "Operational mode. P3/P4 must use SHADOW."
    },
    "phase": {
      "type": "string",
      "enum": ["P3", "P4", "P5"],
      "description": "Phase X phase identifier"
    },
    "run_id": {
      "type": "string",
      "description": "Optional run identifier for traceability"
    },
    "cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "Cycle index if applicable"
    },
    "budget_status": {
      "type": "string",
      "enum": ["UNDER", "NOMINAL", "ELEVATED", "CRITICAL", "EXCEEDED"],
      "description": "Overall budget status based on utilization"
    },
    "utilization_pct": {
      "type": "number",
      "minimum": 0,
      "description": "Overall utilization percentage (can exceed 100% if over-budget)"
    },
    "allocations": {
      "type": "array",
      "description": "Per-resource budget allocations",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["resource_name", "allocated", "consumed", "utilization_pct", "status"],
        "properties": {
          "resource_name": {
            "type": "string",
            "description": "Resource identifier (e.g., 'derivation_steps', 'verification_calls', 'memory_mb', 'time_ms')"
          },
          "layer": {
            "type": "string",
            "enum": ["metrics", "budget", "governance", "replay", "topology", "security", "ht", "tda"],
            "description": "Governance layer this resource belongs to"
          },
          "allocated": {
            "type": "number",
            "minimum": 0,
            "description": "Allocated budget for this resource"
          },
          "consumed": {
            "type": "number",
            "minimum": 0,
            "description": "Currently consumed amount"
          },
          "remaining": {
            "type": "number",
            "description": "Remaining budget (can be negative if exceeded)"
          },
          "utilization_pct": {
            "type": "number",
            "minimum": 0,
            "description": "Utilization percentage for this resource"
          },
          "status": {
            "type": "string",
            "enum": ["UNDER", "NOMINAL", "ELEVATED", "CRITICAL", "EXCEEDED"],
            "description": "Status for this resource"
          },
          "trend": {
            "type": "string",
            "enum": ["increasing", "stable", "decreasing"],
            "description": "Consumption trend for this resource"
          },
          "forecast_exhaustion_cycles": {
            "type": ["integer", "null"],
            "minimum": 0,
            "description": "Estimated cycles until budget exhaustion (null if stable/decreasing)"
          }
        }
      }
    },
    "joint_constraints": {
      "type": "array",
      "description": "Cross-resource joint constraints",
      "items": {
        "type": "object",
        "required": ["constraint_name", "resources", "operator", "satisfied"],
        "properties": {
          "constraint_name": {
            "type": "string",
            "description": "Constraint identifier"
          },
          "resources": {
            "type": "array",
            "items": {"type": "string"},
            "minItems": 2,
            "description": "Resources involved in this joint constraint"
          },
          "operator": {
            "type": "string",
            "enum": ["sum_le", "product_le", "ratio_le", "min_ge"],
            "description": "Constraint operator"
          },
          "threshold": {
            "type": "number",
            "description": "Constraint threshold value"
          },
          "current_value": {
            "type": "number",
            "description": "Current computed value for the constraint"
          },
          "satisfied": {
            "type": "boolean",
            "description": "Whether constraint is currently satisfied"
          },
          "headroom_pct": {
            "type": "number",
            "description": "Percentage headroom before constraint violation"
          }
        }
      }
    },
    "slice_budgets": {
      "type": "object",
      "description": "Per-slice budget breakdown (for slice-aware governance)",
      "additionalProperties": {
        "type": "object",
        "properties": {
          "slice_id": {"type": "string"},
          "allocated": {"type": "number"},
          "consumed": {"type": "number"},
          "utilization_pct": {"type": "number"},
          "status": {
            "type": "string",
            "enum": ["UNDER", "NOMINAL", "ELEVATED", "CRITICAL", "EXCEEDED"]
          }
        }
      }
    },
    "governance_implication": {
      "type": "object",
      "description": "Governance signal implications",
      "properties": {
        "safe_for_promotion": {
          "type": "boolean",
          "description": "Whether budget state allows promotion"
        },
        "throttle_recommended": {
          "type": "boolean",
          "description": "Whether throttling is recommended based on budget"
        },
        "boost_allowed": {
          "type": "boolean",
          "description": "Whether boosting is allowed given budget headroom"
        },
        "blocking_resources": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Resources that are blocking promotion"
        }
      }
    },
    "fo_feedback_alignment": {
      "type": "object",
      "description": "Alignment with FO feedback signals",
      "properties": {
        "fo_throttle_signal": {
          "type": "boolean",
          "description": "FO feedback throttle signal"
        },
        "fo_boost_signal": {
          "type": "boolean",
          "description": "FO feedback boost signal"
        },
        "alignment_status": {
          "type": "string",
          "enum": ["ALIGNED", "TENSION", "CONFLICT"],
          "description": "Alignment between budget and FO feedback"
        },
        "conflict_reason": {
          "type": "string",
          "description": "Reason for conflict if any"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional extended metadata",
      "properties": {
        "computation_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Time taken to compute budget view"
        },
        "budget_epoch": {
          "type": "integer",
          "minimum": 0,
          "description": "Budget epoch for versioning"
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_budget_joint_view",
      "timestamp": "2025-12-10T00:00:00Z",
      "mode": "SHADOW",
      "phase": "P4",
      "run_id": "p4-run-001",
      "cycle": 42,
      "budget_status": "NOMINAL",
      "utilization_pct": 65.5,
      "allocations": [
        {
          "resource_name": "derivation_steps",
          "layer": "budget",
          "allocated": 1000,
          "consumed": 650,
          "remaining": 350,
          "utilization_pct": 65.0,
          "status": "NOMINAL",
          "trend": "stable",
          "forecast_exhaustion_cycles": null
        },
        {
          "resource_name": "verification_calls",
          "layer": "budget",
          "allocated": 500,
          "consumed": 340,
          "remaining": 160,
          "utilization_pct": 68.0,
          "status": "NOMINAL",
          "trend": "increasing",
          "forecast_exhaustion_cycles": 120
        }
      ],
      "joint_constraints": [
        {
          "constraint_name": "verification_ratio",
          "resources": ["verification_calls", "derivation_steps"],
          "operator": "ratio_le",
          "threshold": 0.75,
          "current_value": 0.52,
          "satisfied": true,
          "headroom_pct": 30.7
        }
      ],
      "governance_implication": {
        "safe_for_promotion": true,
        "throttle_recommended": false,
        "boost_allowed": true,
        "blocking_resources": []
      },
      "fo_feedback_alignment": {
        "fo_throttle_signal": false,
        "fo_boost_signal": false,
        "alignment_status": "ALIGNED"
      }
    },
    {
      "schema_version": "1.0.0",
      "signal_type": "metric_budget_joint_view",
      "timestamp": "2025-12-10T01:00:00Z",
      "mode": "SHADOW",
      "phase": "P3",
      "budget_status": "CRITICAL",
      "utilization_pct": 92.0,
      "allocations": [
        {
          "resource_name": "derivation_steps",
          "layer": "budget",
          "allocated": 1000,
          "consumed": 920,
          "remaining": 80,
          "utilization_pct": 92.0,
          "status": "CRITICAL",
          "trend": "increasing",
          "forecast_exhaustion_cycles": 8
        }
      ],
      "governance_implication": {
        "safe_for_promotion": false,
        "throttle_recommended": true,
        "boost_allowed": false,
        "blocking_resources": ["derivation_steps"]
      },
      "fo_feedback_alignment": {
        "fo_throttle_signal": true,
        "fo_boost_signal": false,
        "alignment_status": "ALIGNED"
      }
    }
  ]
}
