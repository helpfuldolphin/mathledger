{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/slice_identity/drift_view.v1.0.0.json",
  "title": "Slice Identity Drift View",
  "description": "Schema for structured view of slice identity drift events. Used by analysis dashboards to visualize parameter deviations and their impact on P3/P4 evidence chains.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "view_type",
    "generated_at",
    "drift_summary",
    "drift_events"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "view_type": {
      "type": "string",
      "const": "slice_identity_drift",
      "description": "Discriminator for view type"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when this view was generated"
    },
    "time_window": {
      "type": "object",
      "properties": {
        "start": {
          "type": "string",
          "format": "date-time",
          "description": "Window start time"
        },
        "end": {
          "type": "string",
          "format": "date-time",
          "description": "Window end time"
        },
        "duration_minutes": {
          "type": "integer",
          "minimum": 0,
          "description": "Window duration in minutes"
        }
      },
      "description": "Time window for drift analysis"
    },
    "drift_summary": {
      "type": "object",
      "required": [
        "total_events",
        "by_severity",
        "by_status",
        "affected_slices",
        "identity_stable"
      ],
      "properties": {
        "total_events": {
          "type": "integer",
          "minimum": 0,
          "description": "Total drift events in window"
        },
        "by_severity": {
          "type": "object",
          "properties": {
            "NONE": {"type": "integer", "minimum": 0},
            "PARAMETRIC": {"type": "integer", "minimum": 0},
            "SEMANTIC": {"type": "integer", "minimum": 0}
          },
          "description": "Event counts by severity classification"
        },
        "by_status": {
          "type": "object",
          "properties": {
            "OK": {"type": "integer", "minimum": 0},
            "WARN": {"type": "integer", "minimum": 0},
            "BLOCK": {"type": "integer", "minimum": 0}
          },
          "description": "Event counts by governance status"
        },
        "affected_slices": {
          "type": "array",
          "items": {"type": "string"},
          "description": "List of slice names with drift detected"
        },
        "identity_stable": {
          "type": "boolean",
          "description": "True if no SEMANTIC drift detected"
        },
        "most_severe_event": {
          "type": ["object", "null"],
          "properties": {
            "slice_name": {"type": "string"},
            "severity": {"type": "string"},
            "timestamp": {"type": "string", "format": "date-time"}
          },
          "description": "Reference to most severe drift event"
        }
      },
      "description": "Aggregate summary of drift events"
    },
    "drift_events": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "event_id",
          "timestamp",
          "slice_name",
          "curriculum_fingerprint",
          "severity",
          "status",
          "changed_params"
        ],
        "properties": {
          "event_id": {
            "type": "string",
            "description": "Unique identifier for this drift event"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time",
            "description": "When drift was detected"
          },
          "slice_name": {
            "type": "string",
            "description": "Name of affected slice"
          },
          "curriculum_fingerprint": {
            "type": "string",
            "description": "Fingerprint of curriculum at detection time"
          },
          "baseline_fingerprint": {
            "type": "string",
            "description": "Expected slice fingerprint"
          },
          "current_fingerprint": {
            "type": "string",
            "description": "Observed slice fingerprint"
          },
          "severity": {
            "type": "string",
            "enum": ["NONE", "PARAMETRIC", "SEMANTIC"],
            "description": "Drift severity classification"
          },
          "status": {
            "type": "string",
            "enum": ["OK", "WARN", "BLOCK"],
            "description": "Governance status triggered"
          },
          "changed_params": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["path", "baseline", "current", "classification"],
              "properties": {
                "path": {
                  "type": "string",
                  "description": "Dot-notation path to changed parameter"
                },
                "baseline": {
                  "description": "Expected value"
                },
                "current": {
                  "description": "Observed value"
                },
                "delta": {
                  "type": ["number", "null"],
                  "description": "Numeric delta if applicable"
                },
                "classification": {
                  "type": "string",
                  "enum": ["PARAMETRIC", "SEMANTIC"],
                  "description": "Change classification"
                },
                "constraint": {
                  "type": "string",
                  "enum": ["increasing", "decreasing", "boolean_true", "any"],
                  "description": "Constraint rule that was evaluated"
                }
              }
            },
            "description": "List of changed parameters with details"
          },
          "evidence_impact": {
            "type": "object",
            "properties": {
              "admissibility": {
                "type": "string",
                "enum": ["FULL", "PARTIAL", "INADMISSIBLE"],
                "description": "Impact on evidence admissibility"
              },
              "affected_runs": {
                "type": "array",
                "items": {"type": "string"},
                "description": "Run IDs affected by this drift"
              },
              "p4_divergence_invalidated": {
                "type": "boolean",
                "description": "Whether P4 divergence analysis is invalidated"
              }
            },
            "description": "Impact on P3/P4 evidence chain"
          },
          "run_context": {
            "type": "object",
            "properties": {
              "run_id": {"type": "string"},
              "cycle": {"type": "integer"},
              "runner_type": {"type": "string", "enum": ["u2", "rfl"]}
            },
            "description": "Context if detected during a run"
          }
        }
      },
      "description": "Individual drift events"
    },
    "invariant_violations": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["invariant_id", "description", "violated_at"],
        "properties": {
          "invariant_id": {
            "type": "string",
            "enum": ["SI-001", "SI-002", "SI-003", "SI-004", "SI-005", "SI-006"],
            "description": "Slice identity invariant ID"
          },
          "description": {
            "type": "string",
            "description": "Human-readable violation description"
          },
          "violated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When violation was detected"
          },
          "related_event_id": {
            "type": "string",
            "description": "Reference to drift event if applicable"
          }
        }
      },
      "description": "Explicit invariant violations detected"
    },
    "recommendations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "priority": {
            "type": "string",
            "enum": ["HIGH", "MEDIUM", "LOW"]
          },
          "action": {
            "type": "string",
            "description": "Recommended action"
          },
          "rationale": {
            "type": "string",
            "description": "Why this action is recommended"
          }
        }
      },
      "description": "Recommended actions based on drift analysis"
    }
  }
}
