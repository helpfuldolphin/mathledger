{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://mathledger.org/schemas/phase_x/governance_signal_unified.v1.0.0.json",
  "title": "Unified Governance Signal",
  "description": "Schema for the unified governance signal envelope containing all input signals, fusion results, and escalation state for Phase X governance fusion layer.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "schema_version",
    "timestamp",
    "cycle",
    "mode",
    "signals",
    "fusion_result",
    "escalation"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Schema version for forward compatibility"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of signal generation"
    },
    "cycle": {
      "type": "integer",
      "minimum": 0,
      "description": "Cycle number at signal generation"
    },
    "mode": {
      "type": "string",
      "enum": ["shadow", "active"],
      "description": "Operational mode (shadow=observational only, active=enforcement enabled)"
    },
    "signals": {
      "type": "object",
      "description": "Container for all input signals",
      "required": [
        "topology",
        "replay",
        "metrics",
        "budget",
        "structure",
        "telemetry",
        "identity",
        "narrative"
      ],
      "properties": {
        "topology": {
          "$ref": "#/definitions/TopologySignal"
        },
        "replay": {
          "$ref": "#/definitions/ReplaySignal"
        },
        "metrics": {
          "$ref": "#/definitions/MetricsSignal"
        },
        "budget": {
          "$ref": "#/definitions/BudgetSignal"
        },
        "structure": {
          "$ref": "#/definitions/StructureSignal"
        },
        "telemetry": {
          "$ref": "#/definitions/TelemetrySignal"
        },
        "identity": {
          "$ref": "#/definitions/IdentitySignal"
        },
        "narrative": {
          "$ref": "#/definitions/NarrativeSignal"
        }
      }
    },
    "fusion_result": {
      "$ref": "#/definitions/FusionResult"
    },
    "escalation": {
      "$ref": "#/definitions/EscalationState"
    },
    "conflict_detections": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ConflictDetection"
      },
      "description": "Cross-signal consistency violations detected"
    },
    "recommendations": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Recommendation"
      },
      "description": "All recommendations extracted from signals"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "fusion_latency_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Time to compute fusion result"
        },
        "signals_received": {
          "type": "integer",
          "minimum": 0,
          "maximum": 8,
          "description": "Number of signals received"
        },
        "signals_valid": {
          "type": "integer",
          "minimum": 0,
          "maximum": 8,
          "description": "Number of signals passing validation"
        }
      }
    }
  },
  "definitions": {
    "TopologySignal": {
      "type": "object",
      "description": "State vector from USLA simulator capturing topological health",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-TOP"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean",
          "description": "Whether signal passed validation"
        },
        "H": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Homological Stability Score"
        },
        "D": {
          "type": "integer",
          "minimum": 0,
          "description": "Current proof depth"
        },
        "D_dot": {
          "type": "number",
          "description": "Depth velocity"
        },
        "B": {
          "type": "number",
          "minimum": 0,
          "description": "Branch factor"
        },
        "S": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Semantic shear"
        },
        "C": {
          "type": "integer",
          "enum": [0, 1, 2],
          "description": "Convergence class (0=CONVERGING, 1=OSCILLATING, 2=DIVERGING)"
        },
        "rho": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Rolling Stability Index"
        },
        "tau": {
          "type": "number",
          "minimum": 0,
          "description": "Effective threshold"
        },
        "J": {
          "type": "number",
          "minimum": 0,
          "description": "Jacobian sensitivity"
        },
        "within_omega": {
          "type": "boolean",
          "description": "Safe region membership"
        },
        "active_cdis": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Active CDI codes"
        },
        "invariant_violations": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Violated invariant IDs"
        }
      }
    },
    "ReplaySignal": {
      "type": "object",
      "description": "Safety assessment from replay verification system",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-RPL"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "replay_verified": {
          "type": "boolean",
          "description": "Last proof successfully replayed"
        },
        "replay_divergence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Divergence from canonical trace"
        },
        "replay_latency_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Replay verification latency"
        },
        "replay_hash_match": {
          "type": "boolean",
          "description": "Hash matches expected"
        },
        "replay_depth_valid": {
          "type": "boolean",
          "description": "Depth within expected bounds"
        }
      }
    },
    "MetricsSignal": {
      "type": "object",
      "description": "Quantitative performance metrics from analytics subsystem",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-MET"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Rolling success rate"
        },
        "abstention_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Rolling abstention rate"
        },
        "block_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Rolling block rate"
        },
        "throughput": {
          "type": "number",
          "minimum": 0,
          "description": "Proofs per cycle"
        },
        "latency_p50_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Median verification latency"
        },
        "latency_p99_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "99th percentile latency"
        },
        "queue_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Pending verification queue"
        }
      }
    },
    "BudgetSignal": {
      "type": "object",
      "description": "Resource budget constraints and utilization",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-BUD"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "compute_budget_remaining": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Remaining compute allocation"
        },
        "memory_utilization": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Current memory usage"
        },
        "storage_headroom_gb": {
          "type": "number",
          "minimum": 0,
          "description": "Available storage"
        },
        "verification_quota_remaining": {
          "type": "integer",
          "minimum": 0,
          "description": "Remaining verifications this epoch"
        },
        "budget_exhaustion_eta_cycles": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles until budget exhaustion"
        }
      }
    },
    "StructureSignal": {
      "type": "object",
      "description": "DAG structural health from proof graph analysis",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-STR"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "dag_coherent": {
          "type": "boolean",
          "description": "DAG passes consistency checks"
        },
        "orphan_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Unlinked proof nodes"
        },
        "max_fanout": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum node children"
        },
        "depth_distribution": {
          "type": "object",
          "additionalProperties": {"type": "integer"},
          "description": "Histogram of proof depths"
        },
        "cycle_detected": {
          "type": "boolean",
          "description": "Cyclic dependency detected"
        },
        "min_cut_capacity": {
          "type": "number",
          "minimum": 0,
          "description": "Minimum cut capacity"
        }
      }
    },
    "TelemetrySignal": {
      "type": "object",
      "description": "Operational telemetry from runtime monitoring",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-TEL"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "lean_healthy": {
          "type": "boolean",
          "description": "Lean verifier responsive"
        },
        "db_healthy": {
          "type": "boolean",
          "description": "Database connection healthy"
        },
        "redis_healthy": {
          "type": "boolean",
          "description": "Redis connection healthy"
        },
        "worker_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Active worker processes"
        },
        "error_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Recent error rate"
        },
        "last_error": {
          "type": ["string", "null"],
          "description": "Most recent error message"
        },
        "uptime_seconds": {
          "type": "integer",
          "minimum": 0,
          "description": "System uptime"
        }
      }
    },
    "IdentitySignal": {
      "type": "object",
      "description": "Cryptographic identity and provenance verification",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-IDN"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "block_hash_valid": {
          "type": "boolean",
          "description": "Current block hash verified"
        },
        "merkle_root_valid": {
          "type": "boolean",
          "description": "Merkle root consistency"
        },
        "signature_valid": {
          "type": "boolean",
          "description": "Block signature verified"
        },
        "chain_continuous": {
          "type": "boolean",
          "description": "No gaps in block sequence"
        },
        "pq_attestation_valid": {
          "type": "boolean",
          "description": "Post-quantum attestation valid"
        },
        "dual_root_consistent": {
          "type": "boolean",
          "description": "Dual-root attestation consistent"
        }
      }
    },
    "NarrativeSignal": {
      "type": "object",
      "description": "High-level curriculum and strategic state",
      "required": ["signal_id", "timestamp", "valid"],
      "properties": {
        "signal_id": {
          "type": "string",
          "const": "SIG-NAR"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "valid": {
          "type": "boolean"
        },
        "current_slice": {
          "type": "string",
          "description": "Active curriculum slice"
        },
        "slice_progress": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Progress through current slice"
        },
        "epoch": {
          "type": "integer",
          "minimum": 0,
          "description": "Current epoch number"
        },
        "curriculum_health": {
          "type": "string",
          "enum": ["HEALTHY", "DEGRADED", "CRITICAL"],
          "description": "Curriculum health classification"
        },
        "drift_detected": {
          "type": "boolean",
          "description": "Curriculum drift detected"
        },
        "narrative_coherence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Narrative consistency score"
        }
      }
    },
    "FusionResult": {
      "type": "object",
      "description": "Result of governance signal fusion",
      "required": ["decision", "is_hard", "primary_reason"],
      "properties": {
        "decision": {
          "type": "string",
          "enum": ["ALLOW", "BLOCK"],
          "description": "Final governance decision"
        },
        "is_hard": {
          "type": "boolean",
          "description": "Whether decision is non-overridable"
        },
        "primary_reason": {
          "type": "string",
          "description": "Primary reason for decision"
        },
        "block_score": {
          "type": "number",
          "minimum": 0,
          "description": "Weighted score for BLOCK recommendations"
        },
        "allow_score": {
          "type": "number",
          "minimum": 0,
          "description": "Weighted score for ALLOW recommendations (includes bias)"
        },
        "determining_signal": {
          "type": "string",
          "description": "Signal ID that primarily determined the outcome"
        }
      }
    },
    "EscalationState": {
      "type": "object",
      "description": "Current escalation level and state",
      "required": ["level", "level_name"],
      "properties": {
        "level": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "description": "Numeric escalation level (0-5)"
        },
        "level_name": {
          "type": "string",
          "enum": ["L0_NOMINAL", "L1_WARNING", "L2_DEGRADED", "L3_CRITICAL", "L4_CONFLICT", "L5_EMERGENCY"],
          "description": "Named escalation level"
        },
        "trigger_reason": {
          "type": "string",
          "description": "Reason for current escalation level"
        },
        "consecutive_cycles_at_level": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles at current level"
        },
        "cooldown_remaining": {
          "type": "integer",
          "minimum": 0,
          "description": "Cycles before de-escalation eligible"
        },
        "alerts_emitted": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Alert channels notified"
        }
      }
    },
    "ConflictDetection": {
      "type": "object",
      "description": "Cross-signal consistency violation",
      "required": ["rule_id", "description", "signals_involved"],
      "properties": {
        "rule_id": {
          "type": "string",
          "pattern": "^CSC-[0-9]{3}$",
          "description": "Consistency rule identifier"
        },
        "description": {
          "type": "string",
          "description": "Human-readable conflict description"
        },
        "signals_involved": {
          "type": "array",
          "items": {"type": "string"},
          "minItems": 2,
          "description": "Signal IDs involved in conflict"
        },
        "severity": {
          "type": "string",
          "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
          "description": "Conflict severity"
        }
      }
    },
    "Recommendation": {
      "type": "object",
      "description": "Individual governance recommendation from a signal",
      "required": ["signal_id", "action", "confidence", "reason", "priority"],
      "properties": {
        "signal_id": {
          "type": "string",
          "description": "Source signal identifier"
        },
        "action": {
          "type": "string",
          "enum": ["ALLOW", "BLOCK", "HARD_BLOCK", "THROTTLE", "EASE", "PAUSE", "WARNING"],
          "description": "Recommended governance action"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence in recommendation"
        },
        "reason": {
          "type": "string",
          "description": "Reason for recommendation"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "description": "Priority weight for voting (1=lowest, 10=highest)"
        },
        "field_trigger": {
          "type": "string",
          "description": "Specific field that triggered recommendation"
        },
        "threshold_value": {
          "type": ["number", "string", "boolean"],
          "description": "Threshold that was violated"
        },
        "actual_value": {
          "type": ["number", "string", "boolean"],
          "description": "Actual value that caused trigger"
        }
      }
    }
  }
}
