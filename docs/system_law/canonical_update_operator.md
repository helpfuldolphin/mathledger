# Canonical Update Operator F

**Document Version:** 0.1.0
**Status:** Core System Law
**Parent:** USLA v0.1

---

## 1. Operator Definition

The canonical update operator **F: X Ã— U Ã— Î˜ â†’ X** defines the complete state transition dynamics of the MathLedger governance-topology organism.

```
xâ‚œâ‚Šâ‚ = F(xâ‚œ, uâ‚œ, Î¸)
```

Where:
- `xâ‚œ âˆˆ â„Â¹âµ` is the current state vector
- `uâ‚œ âˆˆ {0, 1}` is the governance action (ALLOW/BLOCK)
- `Î¸ âˆˆ Î˜` is the parameter manifold
- `xâ‚œâ‚Šâ‚ âˆˆ â„Â¹âµ` is the next state

---

## 2. Operator Pseudocode

```
FUNCTION F(xâ‚œ, uâ‚œ, Î¸):

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: OBSERVATION UPDATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Hâ‚œâ‚Šâ‚ â† observe_hss(cycle_result)
    Dâ‚œâ‚Šâ‚ â† observe_depth(cycle_result)
    á¸Šâ‚œâ‚Šâ‚ â† Dâ‚œâ‚Šâ‚ - Dâ‚œ
    Bâ‚œâ‚Šâ‚ â† observe_branch_factor(cycle_result)
    Sâ‚œâ‚Šâ‚ â† compute_shear(depth_bins, hss_by_depth)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 2: DYNAMICS CLASSIFICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Câ‚œâ‚Šâ‚ â† classify_convergence(Var(H)_history, Îºâ‚œ)
    Îºâ‚œâ‚Šâ‚ â† estimate_coupling(H_history, D_history)
    Î½â‚œâ‚Šâ‚ â† dÂ²Var(H)/dtÂ²

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 3: GOVERNANCE COMPUTATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Adaptive threshold
    Ï„â‚œâ‚Šâ‚ â† Ï„â‚€ Â· (1 + Î±DÂ·á¸Šâ‚œâ‚Šâ‚) Â· (1 + Î±BÂ·(Bâ‚œâ‚Šâ‚ - Bâ‚€)) Â· (1 - Î±SÂ·Sâ‚œâ‚Šâ‚) Â· Î³(Câ‚œâ‚Šâ‚)

    // Jacobian computation
    Jâ‚œâ‚Šâ‚ â† compute_jacobian(xâ‚œâ‚Šâ‚, Ï„â‚œâ‚Šâ‚, Îµ)

    // Exception window update
    Wâ‚œâ‚Šâ‚ â† update_exception_window(Wâ‚œ, Câ‚œâ‚Šâ‚, Sâ‚œâ‚Šâ‚, Î²â‚œ)

    // Governance decision
    uâ‚œ â† G(xâ‚œâ‚Šâ‚) = ğŸ™[Hâ‚œâ‚Šâ‚ < Ï„â‚œâ‚Šâ‚ âˆ§ Â¬Wâ‚œâ‚Šâ‚]

    // Rolling block rate
    Î²â‚œâ‚Šâ‚ â† Î±_Î² Â· Î²â‚œ + (1 - Î±_Î²) Â· uâ‚œ

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 4: STABILITY ASSESSMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Instantaneous stability
    Sáµ¢â‚™â‚›â‚œ â† w_HÂ·s(H) + w_DÂ·s(á¸Š) + w_BÂ·s(B) + w_SÂ·s(S) + w_uÂ·s(u)

    // Rolling Stability Index
    Ïâ‚œâ‚Šâ‚ â† Î±_Ï Â· Ïâ‚œ + (1 - Î±_Ï) Â· Sáµ¢â‚™â‚›â‚œ

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 5: DEFECT DETECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Î´â‚œâ‚Šâ‚ â† |{d âˆˆ CDI : trigger_d(xâ‚œâ‚Šâ‚) > Î¸_d}|

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 6: READINESS COMPUTATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Î“â‚œâ‚Šâ‚ â† wâ‚Â·H_score + wâ‚‚Â·C_score + wâ‚ƒÂ·S_score + wâ‚„Â·B_score + wâ‚…Â·P_score

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 7: INVARIANT VERIFICATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    IF NOT I(xâ‚œâ‚Šâ‚):
        trigger_remediation()

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RETURN UPDATED STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    RETURN xâ‚œâ‚Šâ‚ = [Hâ‚œâ‚Šâ‚, Dâ‚œâ‚Šâ‚, á¸Šâ‚œâ‚Šâ‚, Bâ‚œâ‚Šâ‚, Sâ‚œâ‚Šâ‚, Câ‚œâ‚Šâ‚, Ïâ‚œâ‚Šâ‚, Ï„â‚œâ‚Šâ‚, Jâ‚œâ‚Šâ‚, Wâ‚œâ‚Šâ‚, Î²â‚œâ‚Šâ‚, Îºâ‚œâ‚Šâ‚, Î½â‚œâ‚Šâ‚, Î´â‚œâ‚Šâ‚, Î“â‚œâ‚Šâ‚]
```

---

## 3. Component Functions

### 3.1 Observation Functions

```
observe_hss(cycle_result) â†’ H âˆˆ [0, 1]
    RFL: H = 1.0 - abstention_rate
    U2:  H = windowed_success_rate(window=5)

observe_depth(cycle_result) â†’ D âˆˆ â„¤âº
    D = max(proof_depths in cycle)

observe_branch_factor(cycle_result) â†’ B âˆˆ â„âº
    B = mean(children_count per node)

compute_shear(depth_bins, hss_by_depth) â†’ S âˆˆ [0, 1]
    gradients = [|mean(hss[d+1]) - mean(hss[d])| for d in depths]
    S = max(gradients) / expected_gradient
```

### 3.2 Classification Functions

```
classify_convergence(variance_history, Îº) â†’ C âˆˆ {0, 1, 2}
    slope = linear_fit(variance_history).slope
    mean_var = mean(variance_history)

    IF slope < -0.05 AND mean_var < 0.15:
        RETURN 0  // CONVERGING
    ELIF |slope| < 0.05 AND mean_var > 0.15:
        RETURN 1  // OSCILLATING
    ELSE:
        RETURN 2  // DIVERGING

estimate_coupling(H_history, D_history) â†’ Îº âˆˆ [0, 1]
    Îº = |pearson_correlation(H_history, D_history)|
```

### 3.3 Governance Functions

```
Î³(C) â†’ Î³_C âˆˆ â„âº
    Î³_map = {0: 1.0, 1: 1.1, 2: 1.3}
    RETURN Î³_map[C]

compute_jacobian(x, Ï„, Îµ) â†’ J âˆˆ â„âº
    z = -(H - Ï„) / Îµ
    Ïƒ' = exp(-z) / (1 + exp(-z))Â²
    J = max(|âˆ‚g/âˆ‚H|, |âˆ‚g/âˆ‚á¸Š|, |âˆ‚g/âˆ‚B|, |âˆ‚g/âˆ‚S|)
    RETURN J

update_exception_window(W, C, S, Î²) â†’ W' âˆˆ {0, 1}
    IF W = 0:
        // Activation check
        IF C = 2 OR S > 0.4 OR Î² > 0.5:
            RETURN 1
    ELSE:
        // Deactivation check
        IF C = 0 AND stable_cycles â‰¥ 5:
            RETURN 0
    RETURN W
```

### 3.4 Stability Functions

```
s(H) â†’ [0, 1]
    RETURN min(1.0, H / 0.5) IF H > 0.2 ELSE 0.0

s(á¸Š) â†’ [0, 1]
    RETURN max(0, 1 - |á¸Š| / 3.0)

s(B) â†’ [0, 1]
    RETURN max(0, 1 - B / 10.0)

s(S) â†’ [0, 1]
    RETURN max(0, 1 - S / 0.5)

s(u) â†’ [0, 1]
    RETURN 0.8 IF u = 1 ELSE 1.0
```

---

## 4. State Transition Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           CYCLE INPUT               â”‚
                    â”‚  (cycle_result, telemetry)          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: OBSERVATION                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   H   â”‚  â”‚   D   â”‚  â”‚   á¸Š   â”‚  â”‚   B   â”‚  â”‚   S   â”‚            â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚          â”‚          â”‚          â”‚
       â–¼          â–¼          â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: DYNAMICS CLASSIFICATION                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚   C   â”‚  â”‚   Îº   â”‚  â”‚   Î½   â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚          â”‚
       â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: GOVERNANCE                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Ï„   â”‚â†’ â”‚   J   â”‚  â”‚   W   â”‚â†’ â”‚   u   â”‚â†’ â”‚   Î²   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 4-6: STABILITY / DEFECTS / READINESS                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚   Ï   â”‚  â”‚   Î´   â”‚  â”‚   Î“   â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           xâ‚œâ‚Šâ‚ OUTPUT               â”‚
                    â”‚  [H, D, á¸Š, B, S, C, Ï, Ï„, J,        â”‚
                    â”‚   W, Î², Îº, Î½, Î´, Î“]                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Computational Complexity

| Phase | Operations | Complexity |
|-------|------------|------------|
| Observation | 5 scalar reads | O(1) |
| Classification | Variance, correlation | O(window) |
| Governance | Threshold, Jacobian | O(1) |
| Stability | Weighted sum | O(1) |
| Defects | 10 predicate checks | O(1) |
| Readiness | 5 component scores | O(1) |

**Total per-cycle complexity:** O(window) â‰ˆ O(10) = O(1)

---

## 6. Implementation Reference

See: `backend/topology/usla_simulator.py`

