# U2 Environment Enforcement Specification

**ID:** `U2_EES_v1.0`
**Author:** GEMINI N, Environment Hardening Engineer
**Status:** DRAFT
**Date:** 2025-12-05
**Scope:** Defines the charter, rules, and semantics for the `validate_u2_environment.py` script and its role in safeguarding Phase II U2 Uplift Experiments.

---

## 1. Charter & Purpose

This document specifies the **U2 Environment Enforcement Charter**. Its purpose is to guarantee that every U2 Uplift Experiment operates within a secure, isolated, and deterministic environment. It achieves this by defining a set of strict, machine-verifiable rules enforced by the `validate_u2_environment.py` script.

This specification serves as the canonical source of truth for:
- The behavior of the validation script.
- The contractual obligations of the environment in which a U2 run is executed.
- The integration semantics for Continuous Integration (CI) and automated run orchestration.

**Adherence to this charter is not optional.** No U2 experiment may be considered valid unless a passing Pre-Run Environment Report, generated by the tool specified herein, is included in its evidence pack.

---

## 2. Full Rule Set

The validator script enforces the following rules. Each rule is mapped to a Non-Functional Requirement (NFR) ID from the `first_organism_env_hardening_plan.md` document.

| Rule ID | NFR | Check Description | Enforcement Point & Details |
|---|---|---|---|
| **RULE-001** | NFR-001 | **Mode Declaration** | Verifies that the `RFL_ENV_MODE` environment variable is explicitly set to one of the valid values (`phase1-hermetic`, `uplift_experiment`, `uplift_analysis`). Fails if the variable is unset or contains an invalid value. |
| **RULE-002** | NFR-002 | **Cache Root Configuration** | Verifies that the `MATHLEDGER_CACHE_ROOT` environment variable is set. |
| **RULE-003** | NFR-002 | **Cache Root Existence** | Verifies that the path specified by `MATHLEDGER_CACHE_ROOT` exists on the filesystem. |
| **RULE-004** | NFR-002 | **Cache Root Writability** | Verifies that the process has write permissions for the path specified by `MATHLEDGER_CACHE_ROOT`. |
| **RULE-005** | NFR-002 | **Cache Root Symlink Prohibition**| Verifies that the path specified by `MATHLEDGER_CACHE_ROOT` is a directory and not a symbolic link. This is a critical security check to prevent path traversal and filesystem attacks. |
| **RULE-006** | NFR-002 | **Run ID Path Traversal** | Verifies that the `U2_RUN_ID` environment variable does not contain path traversal sequences (`../`, `..\`). This prevents a malicious `U2_RUN_ID` from causing the script to write outside the intended cache directory. |
| **RULE-007** | NFR-005 | **Snapshot Root Configuration** | Verifies that the `MATHLEDGER_SNAPSHOT_ROOT` environment variable is set. |
| **RULE-008** | NFR-005 | **Snapshot Root Integrity** | Performs existence, writability, and symlink checks on the `MATHLEDGER_SNAPSHOT_ROOT` path, identical to RULE-003 through RULE-005. |
| **RULE-009** | NFR-003 | **Master Seed Configuration** | Verifies that the `U2_MASTER_SEED` environment variable is set. |
| **RULE-010** | NFR-003 | **Master Seed Format** | Verifies that `U2_MASTER_SEED` is a 64-character hexadecimal string, matching the format of a SHA256 hash. |
| **RULE-011**| NFR-003 | **Master Seed Preregistration Match** | During a mode switch, verifies that the `U2_MASTER_SEED` value exactly matches the `--prereg-hash` provided to the script. This creates a cryptographic link between the run and its preregistration document. |
| **RULE-012**| NFR-007 | **Banned Randomness Scan** | Performs a static analysis of the abstract syntax tree (AST) for all `.py` files in `backend/rfl/` to detect calls to banned functions in the `random` module. |
| **RULE-013**| N/A | **Database Schema Version** | Connects to the database and verifies that the current applied schema migration version matches a pinned, expected version number from the environment. |
| **RULE-014**| N/A | **Disk Space Threshold** | Verifies that the filesystem hosting the cache and export directories has at least 1 GB of free space. |
| **RULE-015**| N/A | **Disallowed Listening Sockets** | Verifies that there are no active network sockets in a `LISTEN` state on a predefined set of disallowed ports (e.g., 80, 443, 8080). |

### 2.1 Mode-Switch Specific Rules

These rules are only enforced when a mode switch is actively being performed.

| Rule ID | NFR | Check Description | Enforcement Point & Details |
|---|---|---|---|
| **RULE-901**| N/A | **Lockfile Existence** | During a mode switch, verifies that a `.mode_lock` file does *not* already exist in the target run directory. This enforces the one-way nature of the mode transition. |

---

## 3. Lockfile Invariants

The `.mode_lock` file is the immutable, auditable record of an environment's transition into a Phase II state. Its properties and behavior are governed by the following invariants.

1.  **Uniqueness and Location:**
    *   There MUST be **zero or one** `.mode_lock` file per run ID.
    *   Its path is rigidly defined as: `${MATHLEDGER_CACHE_ROOT}/u2/${U2_RUN_ID}/.mode_lock`.

2.  **Immutability:**
    *   Once created, the `.mode_lock` file MUST NOT be modified, renamed, or deleted. Any such action invalidates the run and constitutes a "tampering" event.
    *   The file represents a **one-way state transition**. Its presence is a permanent fact about the run's history.

3.  **Creation Condition:**
    *   The file is created **if and only if** a mode switch is requested (`--switch-mode`) and *all* validation rules pass, including the mandatory presence of the `--confirm-phase2`, `--operator-id`, and `--prereg-hash` flags.
    *   The creation is the final step in the validation-and-switch process, acting as an atomic commit of the transaction.

4.  **Schema and Content:**
    *   The file MUST contain a JSON object conforming to the following schema:
        ```json
        {
          "mode": "uplift_experiment",
          "switched_at": "<ISO8601 UTC timestamp>",
          "operator_id": "<string, from --operator-id>",
          "prereg_hash": "<64-char hex string>",
          "is_reversible": false
        }
        ```
    *   The `is_reversible` field MUST always be `false`.

---

## 4. Validation Order

To ensure correctness and fail-fast behavior, the `validate_u2_environment.py` script executes checks in a specific, logical sequence.

1.  **CLI Argument Parsing:** The script first parses all command-line arguments.
2.  **Environment Variable Presence & Format:**
    *   Check for `RFL_ENV_MODE` (RULE-001).
    *   Check for `U2_RUN_ID`, `U2_MASTER_SEED`, `MATHLEDGER_CACHE_ROOT`, `MATHLEDGER_SNAPSHOT_ROOT`.
    *   Validate format of `U2_MASTER_SEED` (RULE-010).
    *   Validate `U2_RUN_ID` for path traversal characters (RULE-006).
3.  **Filesystem Checks:**
    *   Validate `MATHLEDGER_CACHE_ROOT` (existence, writability, no symlinks) (RULES-003, 004, 005).
    *   Validate `MATHLEDGER_SNAPSHOT_ROOT` (existence, writability, no symlinks) (RULE-008).
4.  **Code Scans:**
    *   Perform the banned randomness scan (RULE-012).
5.  **Mode-Switch Pre-validation (if `--switch-mode` is present):**
    *   Check for the presence of the `.mode_lock` file (RULE-013). If it exists, halt immediately with a specific error code.
    *   Verify the `U2_MASTER_SEED` matches the `--prereg-hash` (RULE-011).
    *   Verify `--confirm-phase2` and `--operator-id` are present.
6.  **Report Generation:** The JSON report is generated based on the results of all preceding checks.
7.  **Final Action:**
    *   If a valid mode switch was requested, the `.mode_lock` file is written.
    *   The script exits with the appropriate code.

---

## 5. Failure Modes & CI Semantics

The script's exit code provides a clear, machine-readable signal for CI/CD systems.

| Exit Code | Severity | Failure Mode | CI Semantics & Recommended Action |
|---|---|---|---|
| **0** | `PASS` | **All checks passed.** | **Proceed.** The environment is clean. Safe to execute the U2 run. |
| **1** | `ERROR` | **Core Validation Failed.** A critical rule (e.g., missing variable, unwritable directory, hash mismatch) failed. | **FAIL BUILD/RUN.** This indicates a fundamental misconfiguration. The run must not proceed. The JSON report should be archived as a build artifact for debugging. |
| **2** | `WARN` | **Strict Mode Failure.** A check with `WARN` severity (e.g., Banned Randomness Scan) failed, and the script was run with `--strict`. | **FAIL BUILD/RUN.** This is a policy-level failure. The code should be reviewed and fixed before being allowed to proceed. |
| **3** | `ERROR` | **Mode Switch Authorization Denied.** A mode switch was attempted without the required flags (`--confirm-phase2`, `--operator-id`, etc.). | **FAIL BUILD/RUN.** This is a security failure, indicating an improper attempt to change the environment state. Alert security/devops. |
| **5** | `ERROR` | **Lockfile Conflict.** A mode switch was attempted for a run that has already been switched (i.e., `.mode_lock` already exists). | **FAIL BUILD/RUN.** This indicates a logical error in the run orchestration (e.g., re-running an old job). Investigate the run ID conflict. |

---

## 6. Threat Model: Environment Contamination

This threat model identifies potential vectors for environment contamination that would compromise the determinism or validity of a U2 experiment and specifies the mitigations provided by this enforcement charter.

| Threat ID | Threat Description | Attack / Failure Scenario | Mitigation(s) |
|---|---|---|---|
| **T-001** | **Cross-Run State Contamination** | A bug or misconfiguration causes data from `run_A`'s cache (e.g., derived mathematical statements, policy weights) to be read by `run_B`, invalidating its results. | - **RULE-006:** The validator prohibits path traversal characters in `U2_RUN_ID`, preventing it from pointing to another run's directory. <br>- **Strict per-run directory structure:** The architecture (`/u2/${U2_RUN_ID}/`) isolates run artifacts by design. |
| **T-002** | **Filesystem Integrity Violation (Symlink Attack)** | Before a run starts, an attacker replaces a cache subdirectory with a symbolic link pointing to a sensitive file (e.g., `/etc/shadow`, `~/.aws/credentials`). When the U2 runner (potentially in a container) writes to its cache, it inadvertently overwrites or exfiltrates the target file. | - **RULE-005 & RULE-008:** The validator explicitly checks that the cache and snapshot root paths are not symlinks. This check is performed *just-in-time* before the run, defeating pre-run race conditions. |
| **T-003** | **Implicit Execution in an Unsafe Mode** | A developer, testing locally, forgets to set `RFL_ENV_MODE`. The system defaults to `uplift_experiment` and connects to a database, contaminating a production or staging environment with test data. | - **RULE-001:** The validator fails if `RFL_ENV_MODE` is not *explicitly* set. There is no "default" to a dangerous mode. <br>- **Mode-Switch Guardrails:** The entire `--confirm-phase2` and `.mode_lock` system makes transitioning to `uplift_experiment` a deliberate, audited, one-way action, not an accident. |
| **T-004** | **Non-Deterministic Code Injection** | A developer introduces a call to `random.choice()` in a core policy-update module to resolve a tie-break. The run is no longer reproducible, but this is not discovered until weeks later. | - **RULE-012:** The banned randomness scan provides an automated, first-line defense by flagging such imports in CI. <br>- **`--strict` flag:** Enforcing strict mode in CI turns these warnings into build failures, preventing the code from being merged. <br>- **Deterministic PRNG Framework:** The existence of a sanctioned `DeterministicPRNG` class provides a clear, correct alternative, reducing the likelihood of developers reaching for the `random` module. |
| **T-005** | **Preregistration Mismatch** | An operator accidentally provides an outdated preregistration hash or an incorrect `U2_MASTER_SEED` when initiating a run. The experiment that runs does not match the experiment that was formally approved. | - **RULE-011:** The validator cryptographically binds the `U2_MASTER_SEED` to the preregistration hash at the moment of mode-switch. <br>- **Lockfile Invariants:** The `.mode_lock` file creates a permanent, auditable record of which preregistration hash was used for the run, allowing for post-hoc verification. |
| **T-006** | **Run State Re-execution** | An orchestration error triggers a U2 run using a `U2_RUN_ID` that has already been used for a completed (or failed) run. This could overwrite previous evidence or blend results from two different executions under one ID. | - **RULE-013 & Exit Code 5:** The validator will detect the existing `.mode_lock` file and immediately halt with a specific, machine-readable error, preventing the re-execution. This makes the run ID a true nonce (number used once). |
