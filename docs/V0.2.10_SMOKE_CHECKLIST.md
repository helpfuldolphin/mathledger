# v0.2.10 Demo Reliability Smoke Checklist

**Tag:** `v0.2.10-demo-reliability`
**Date:** 2026-01-04
**Scope:** Infrastructure fix only - no cryptographic contract changes

## Problem Solved

Demo reliability failure where `commit_uvil` returns 404 after server restart due to `proposal_id` cache miss. The fix makes commit self-sufficient via `draft_payload`.

## Pre-Deploy Verification

Run regression tests locally:
```powershell
uv run pytest tests/demo/test_demo_reliability.py -v
```

Expected: 7 tests pass

| Test | Description |
|------|-------------|
| `test_commit_with_draft_payload_succeeds` | Core fix: commit works with draft_payload |
| `test_commit_works_after_cache_clear` | Commit succeeds even when proposal cache is cleared |
| `test_commit_without_draft_payload_fails_after_cache_clear` | Legacy mode fails gracefully with system-responsible error |
| `test_boundary_demo_full_sequence` | Full boundary demo sequence (ADV/PA/MV) completes |
| `test_proposal_state_lost_error_is_system_responsible` | Error message does not blame user |
| `test_missing_proposal_data_error` | Missing data returns 400 with clear error |
| `test_double_commit_rejected_with_draft_payload` | Idempotency preserved via proposal_id in draft_payload |

## Deploy-by-Tag Doctrine Checklist

Before deploying, verify ALL conditions:

```powershell
# 1. Verify clean working tree
git -C C:/dev/mathledger status --short
# Expected: No uncommitted changes (or only untracked files)

# 2. Verify tag exists on origin
git -C C:/dev/mathledger fetch --tags
git -C C:/dev/mathledger tag -l "v0.2.10-demo-reliability"
# Expected: Tag listed

# 3. Verify HEAD matches tag
git -C C:/dev/mathledger describe --exact-match HEAD
# Expected: v0.2.10-demo-reliability

# 4. Verify releases.json matches
uv run python -c "import json; r=json.load(open('releases/releases.json')); print(r['current_version'], r['versions']['v0.2.10']['tag'])"
# Expected: v0.2.10 v0.2.10-demo-reliability
```

## Post-Deploy Smoke Tests (Live URLs)

After deployment, verify the fix works on production:

### 1. Health Check
```powershell
curl.exe https://mathledger.ai/demo/health
```
Expected: `{"status":"healthy","version":"v0.2.10",...}`

### 2. Boundary Demo Sequence (Manual)
1. Navigate to: https://mathledger.ai/demo/
2. Click "Run Boundary Demo"
3. Verify: All 4 steps complete without ERROR
   - ADV claim: ABSTAINED
   - PA claim: ABSTAINED
   - MV true claim: VERIFIED
   - MV false claim: REFUTED

### 3. Propose-Commit Cycle (API)
```powershell
# Propose
$propose = Invoke-RestMethod -Uri "https://mathledger.ai/demo/uvil/propose_partition" -Method Post -ContentType "application/json" -Body '{"problem_statement":"Smoke test"}'
$propose.draft_payload  # Should exist

# Commit using draft_payload (the fix)
$body = @{
    draft_payload = $propose.draft_payload
    edited_claims = @(@{claim_text="1+1=2"; trust_class="MV"; rationale="test"})
} | ConvertTo-Json -Depth 5
Invoke-RestMethod -Uri "https://mathledger.ai/demo/uvil/commit_uvil" -Method Post -ContentType "application/json" -Body $body
# Expected: Returns committed_partition_id, u_t, r_t, h_t
```

### 4. Error Message Verification
```powershell
# Commit with fake proposal_id (should fail gracefully)
$body = '{"proposal_id":"00000000-0000-0000-0000-000000000000","edited_claims":[{"claim_text":"x","trust_class":"MV","rationale":""}]}'
try {
    Invoke-RestMethod -Uri "https://mathledger.ai/demo/uvil/commit_uvil" -Method Post -ContentType "application/json" -Body $body
} catch {
    $_.ErrorDetails.Message  # Should contain "demo reliability issue" NOT "Must call /propose_partition first"
}
```

## Tag and Deploy Instructions

### Step 1: Create Annotated Tag
```powershell
git -C C:/dev/mathledger tag -a v0.2.10-demo-reliability -m "$(cat <<'EOF'
MathLedger v0.2.10 (Demo Reliability Fix)

Fixes intermittent 404 errors in hosted demo caused by proposal_id
cache miss after server restart or multi-instance routing.

Solution: Self-sufficient commit via draft_payload.
- propose_partition now returns full draft_payload
- commit_uvil accepts draft_payload directly (no server-side lookup)
- Error messages are system-responsible, not user-blaming

No changes to:
- Cryptographic contracts (U_t, R_t, H_t)
- Invariant tiers
- Verifier semantics

Tests: 7 new regression tests in tests/demo/test_demo_reliability.py
EOF
)"
```

### Step 2: Push Tag
```powershell
git -C C:/dev/mathledger push origin v0.2.10-demo-reliability
```

### Step 3: Deploy to Fly.io
```powershell
# Checkout the exact tag
git -C C:/dev/mathledger checkout v0.2.10-demo-reliability

# Deploy
fly deploy -a mathledger-demo --dockerfile Dockerfile
```

### Step 4: Verify Deployment
Run Post-Deploy Smoke Tests above.

### Step 5: Update Cloudflare Worker (if needed)
The Worker routes `/demo/*` to Fly.io origin. No Worker changes needed for v0.2.10.

## Rollback Instructions

If smoke tests fail:
```powershell
# Rollback to previous version
git -C C:/dev/mathledger checkout v0.2.9-abstention-terminality
fly deploy -a mathledger-demo --dockerfile Dockerfile
```

## Invariants Preserved

- **T1:** proposal_id never enters hash-committed payloads (unchanged)
- **T2:** ADV claims excluded from R_t (unchanged)
- **T6:** Abstention outcomes preserved (unchanged)
- **Cryptographic contracts:** U_t, R_t, H_t computation unchanged

## Files Changed

| File | Change |
|------|--------|
| `backend/api/uvil.py` | Added DraftPayload model, updated ProposePartitionResponse, modified commit_uvil |
| `demo/app.py` | Frontend JS stores and sends draft_payload |
| `tests/demo/test_demo_reliability.py` | 7 new regression tests |
| `releases/releases.json` | v0.2.10 entry added |
