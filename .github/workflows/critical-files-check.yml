name: Critical Files Check

on:
  push:
    branches: [master, main, integrate/*]
  pull_request:
    branches: [master, main, integrate/*]

jobs:
  critical-files:
    name: Verify Critical Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check Tier 1 critical files exist
        run: |
          echo "Checking Tier 1 (ABSOLUTELY CRITICAL) files..."
          MISSING=0

          TIER1_FILES=(
            "backend/worker.py"
            "backend/lean_mode.py"
            "attestation/dual_root.py"
            "normalization/canon.py"
            "normalization/taut.py"
            "backend/axiom_engine/derive_core.py"
            "backend/axiom_engine/axioms.py"
            "backend/axiom_engine/rules.py"
            "backend/crypto/core.py"
            "backend/lean_proj/lakefile.lean"
            "backend/lean_proj/lean-toolchain"
          )

          for file in "${TIER1_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::CRITICAL: Missing Tier 1 file: $file"
              MISSING=$((MISSING + 1))
            else
              echo "  OK: $file"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "::error::$MISSING Tier 1 critical files are missing!"
            exit 1
          fi
          echo "All Tier 1 files present."

      - name: Check Tier 2 critical files exist
        run: |
          echo "Checking Tier 2 (OPERATIONALLY CRITICAL) files..."
          MISSING=0

          TIER2_FILES=(
            "scripts/generate_first_light_status.py"
            "curriculum/gates.py"
            "backend/topology/usla_simulator.py"
            "backend/topology/usla_integration.py"
          )

          for file in "${TIER2_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::warning::Missing Tier 2 file: $file"
              MISSING=$((MISSING + 1))
            else
              echo "  OK: $file"
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "::warning::$MISSING Tier 2 critical files are missing"
          else
            echo "All Tier 2 files present."
          fi

      - name: Validate critical Python files compile
        run: |
          echo "Validating Python syntax for critical files..."
          ERRORS=0

          VALIDATE_FILES=(
            "backend/worker.py"
            "attestation/dual_root.py"
            "normalization/canon.py"
            "normalization/taut.py"
            "scripts/generate_first_light_status.py"
            "backend/axiom_engine/derive_core.py"
          )

          for file in "${VALIDATE_FILES[@]}"; do
            if [ -f "$file" ]; then
              if python -m py_compile "$file" 2>/dev/null; then
                echo "  VALID: $file"
              else
                echo "::error::SYNTAX ERROR in $file"
                ERRORS=$((ERRORS + 1))
              fi
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "::error::$ERRORS critical files have syntax errors!"
            exit 1
          fi
          echo "All critical files have valid syntax."

      - name: Check for corrupted files (suspiciously small)
        run: |
          echo "Checking for potentially corrupted files..."
          SUSPICIOUS=0

          # Files that should be > 1KB
          LARGE_FILES=(
            "backend/worker.py:1000"
            "attestation/dual_root.py:1000"
            "backend/axiom_engine/derive_core.py:1000"
            "scripts/generate_first_light_status.py:500"
          )

          for entry in "${LARGE_FILES[@]}"; do
            file="${entry%%:*}"
            min_size="${entry##*:}"
            if [ -f "$file" ]; then
              actual_size=$(wc -c < "$file")
              if [ "$actual_size" -lt "$min_size" ]; then
                echo "::warning::$file is suspiciously small ($actual_size bytes, expected > $min_size)"
                SUSPICIOUS=$((SUSPICIOUS + 1))
              fi
            fi
          done

          if [ $SUSPICIOUS -gt 0 ]; then
            echo "::warning::$SUSPICIOUS files are suspiciously small - may be corrupted"
          else
            echo "No suspiciously small files detected."
          fi

      - name: Report untracked files in critical paths
        run: |
          echo "Checking for untracked Python files in critical paths..."

          # Find untracked .py files in critical directories
          UNTRACKED=$(git ls-files --others --exclude-standard | grep -E "^(scripts|backend|attestation|curriculum|normalization)/.*\.py$" | head -20 || true)

          if [ -n "$UNTRACKED" ]; then
            echo "::warning::Untracked Python files in critical paths:"
            echo "$UNTRACKED"
            echo ""
            echo "Consider tracking these files to prevent corruption."
          else
            echo "No untracked Python files in critical paths."
          fi

      - name: Generate integrity report
        run: |
          echo "# Critical Files Integrity Report" > critical_files_report.md
          echo "" >> critical_files_report.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> critical_files_report.md
          echo "Commit: ${{ github.sha }}" >> critical_files_report.md
          echo "" >> critical_files_report.md
          echo "## File Hashes" >> critical_files_report.md
          echo "" >> critical_files_report.md
          echo '```' >> critical_files_report.md

          for file in backend/worker.py attestation/dual_root.py normalization/canon.py scripts/generate_first_light_status.py; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> critical_files_report.md
            fi
          done

          echo '```' >> critical_files_report.md
          cat critical_files_report.md

      - name: Upload integrity report
        uses: actions/upload-artifact@v4
        with:
          name: critical-files-report
          path: critical_files_report.md
          retention-days: 30
