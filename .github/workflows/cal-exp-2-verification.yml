# CAL-EXP-2 Run Verification (NON-GATING)
#
# Canonical Contract: docs/system_law/calibration/RUN_SHADOW_AUDIT_V0_1_CONTRACT.md
#
# SHADOW MODE CONTRACT:
# - This workflow is ADVISORY ONLY (never blocks merges)
# - Runs verification if results/cal_exp_2/**/run_config.json exists
# - All outputs have mode="SHADOW", enforcement=false
# - continue-on-error: true for verification steps
#
# Purpose: Automated post-run invariant checking for CAL-EXP-2 experiments

name: CAL-EXP-2 Verification

on:
  push:
    branches: [integrate/ledger-v0.1, master]
    paths:
      - 'results/cal_exp_2/**'
      - 'scripts/verify_cal_exp_2_run.py'
      - 'tests/ci/test_verify_cal_exp_2_run.py'

  pull_request:
    branches: [integrate/ledger-v0.1, master]
    paths:
      - 'results/cal_exp_2/**'
      - 'scripts/verify_cal_exp_2_run.py'
      - 'tests/ci/test_verify_cal_exp_2_run.py'

  workflow_dispatch:
    inputs:
      run_dir:
        description: 'Specific run directory to verify (optional)'
        required: false
        default: ''
        type: string

env:
  # SHADOW MODE: Always enabled
  USLA_SHADOW_ENABLED: 'true'
  SHADOW_MODE_ENABLED: 'true'
  PYTHONUTF8: '1'

jobs:
  # ---------------------------------------------------------------------------
  # Unit Tests (BLOCKING on script failures only)
  # ---------------------------------------------------------------------------
  verifier-tests:
    name: Verifier Unit Tests
    runs-on: ubuntu-latest
    continue-on-error: false  # Script failures block

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        run: uv sync

      - name: Run verifier unit tests
        run: |
          echo "=== CAL-EXP-2 VERIFIER UNIT TESTS ==="
          echo "Testing: verify_cal_exp_2_run.py"
          echo ""
          uv run pytest tests/ci/test_verify_cal_exp_2_run.py \
            -v --tb=short \
            -m unit \
            --junit-xml=results/verifier-tests.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verifier-test-results
          path: results/verifier-tests.xml
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Run Verification (NON-GATING - advisory only)
  # ---------------------------------------------------------------------------
  verify-runs:
    name: Verify CAL-EXP-2 Runs
    runs-on: ubuntu-latest
    # CRITICAL: Advisory only - NEVER block merges
    continue-on-error: true
    needs: verifier-tests

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v1

      - name: Install dependencies
        run: uv sync

      - name: Check for CAL-EXP-2 runs
        id: check-runs
        run: |
          echo "=== CHECKING FOR CAL-EXP-2 RUNS ==="

          # Check if results/cal_exp_2 exists and has run directories
          if [ ! -d "results/cal_exp_2" ]; then
            echo "No results/cal_exp_2 directory found."
            echo "has_runs=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find all run_config.json files
          RUN_CONFIGS=$(find results/cal_exp_2 -name "run_config.json" -type f 2>/dev/null || true)

          if [ -z "$RUN_CONFIGS" ]; then
            echo "No run_config.json files found in results/cal_exp_2/"
            echo "has_runs=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found CAL-EXP-2 runs:"
          echo "$RUN_CONFIGS" | while read f; do
            echo "  - $(dirname $f)"
          done

          echo "has_runs=true" >> $GITHUB_OUTPUT

      - name: Verify specific run (manual trigger)
        if: github.event.inputs.run_dir != '' && steps.check-runs.outputs.has_runs == 'true'
        continue-on-error: true
        run: |
          echo "=== VERIFYING SPECIFIC RUN ==="
          echo "Run directory: ${{ github.event.inputs.run_dir }}"
          echo ""

          mkdir -p results/verification_reports

          uv run python scripts/verify_cal_exp_2_run.py \
            --run-dir "${{ github.event.inputs.run_dir }}" \
            --output-report results/verification_reports/manual_verification_report.json

      - name: Verify all runs (automatic)
        if: github.event.inputs.run_dir == '' && steps.check-runs.outputs.has_runs == 'true'
        continue-on-error: true
        run: |
          echo "=== VERIFYING ALL CAL-EXP-2 RUNS ==="
          echo "SHADOW MODE: Advisory only, non-blocking"
          echo ""

          mkdir -p results/verification_reports

          # Track overall status
          PASS_COUNT=0
          FAIL_COUNT=0
          SKIP_COUNT=0

          # Find and verify all run directories
          find results/cal_exp_2 -name "run_config.json" -type f | while read config_file; do
            RUN_DIR=$(dirname "$config_file")
            RUN_NAME=$(basename "$RUN_DIR")

            echo "----------------------------------------"
            echo "Verifying: $RUN_DIR"
            echo ""

            # Run verification (continue even on failure)
            if uv run python scripts/verify_cal_exp_2_run.py \
                --run-dir "$RUN_DIR" \
                --output-report "results/verification_reports/${RUN_NAME}_verification_report.json"; then
              echo "RESULT: PASS"
            else
              echo "RESULT: FAIL (advisory only)"
            fi
            echo ""
          done

          echo "========================================"
          echo "Verification complete (advisory only)"
          echo "========================================"

      - name: No runs to verify
        if: steps.check-runs.outputs.has_runs != 'true'
        run: |
          echo "=== NO CAL-EXP-2 RUNS FOUND ==="
          echo "No results/cal_exp_2/**/run_config.json files detected."
          echo "This is expected if no CAL-EXP-2 experiments have been committed."
          echo ""

          # Create placeholder report for artifact upload
          mkdir -p results/verification_reports
          cat > results/verification_reports/no_runs_placeholder.json << 'EOF'
          {
            "schema_version": "1.0.0",
            "verifier": "verify_cal_exp_2_run.py",
            "status": "NO_RUNS_FOUND",
            "message": "No CAL-EXP-2 run directories found in results/cal_exp_2/"
          }
          EOF

      - name: Upload verification reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cal-exp-2-verification-reports-${{ github.run_number }}
          path: results/verification_reports/
          retention-days: 90

  # ---------------------------------------------------------------------------
  # Summary (Always runs, NON-GATING)
  # ---------------------------------------------------------------------------
  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [verifier-tests, verify-runs]

    steps:
      - name: Report Status
        run: |
          echo "========================================"
          echo "CAL-EXP-2 VERIFICATION SUMMARY"
          echo "========================================"
          echo ""
          echo "SHADOW MODE CONTRACT:"
          echo "  - Verification results: ADVISORY ONLY"
          echo "  - This workflow NEVER blocks merges"
          echo "  - Mode marker: SHADOW"
          echo "  - Enforcement: FALSE"
          echo ""
          echo "RESULTS:"
          echo "  Verifier Tests: ${{ needs.verifier-tests.result }}"
          echo "  Run Verification: ${{ needs.verify-runs.result }}"
          echo ""

          # Only the unit tests can fail the workflow
          if [ "${{ needs.verifier-tests.result }}" = "failure" ]; then
            echo "STATUS: VERIFIER TESTS FAILED (script issue)"
            echo "Note: Run verification results are always advisory."
            exit 1
          fi

          echo "STATUS: COMPLETE (verification results are advisory)"
          echo "========================================"
