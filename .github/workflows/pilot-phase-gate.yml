name: Pilot Phase Gate

# =============================================================================
# PILOT CI ISOLATION
# =============================================================================
# This workflow is STRICTLY SCOPED to pilot-phase paths only.
# It NEVER triggers on CAL-EXP paths and NEVER modifies frozen experiments.
#
# ISOLATION GUARANTEES:
# 1. Only triggers on pilot/, external_ingest/, adapters/ paths
# 2. Explicitly excludes CAL-EXP harness paths
# 3. Validates pilot code does not write to results/cal_exp_* directories
# 4. Docs-only pilot changes do not trigger experiment gates
# =============================================================================

on:
  push:
    branches: [master, main, 'integrate/**', 'pilot/**']
    paths:
      # Pilot-specific paths ONLY
      - 'pilot/**'
      - 'external_ingest/**'
      - 'adapters/**'
      # Pilot adapter in backend/health
      - 'backend/health/pilot_*.py'
      # Pilot documentation (scoped)
      - 'docs/pilot/**'
      # Pilot tests (scoped)
      - 'tests/pilot/**'
      # Pilot policy tests (text neutrality)
      - 'tests/policy/test_pilot_*.py'
      # Pilot integration tests (signal isolation)
      - 'tests/integration/test_*pilot*.py'
      # Pilot scripts (explicit prefix)
      - 'scripts/pilot_*.py'
      # This workflow itself
      - '.github/workflows/pilot-phase-gate.yml'
  pull_request:
    branches: [master, main, 'integrate/**']
    paths:
      # Pilot-specific paths ONLY
      - 'pilot/**'
      - 'external_ingest/**'
      - 'adapters/**'
      # Pilot adapter in backend/health
      - 'backend/health/pilot_*.py'
      # Pilot documentation (scoped)
      - 'docs/pilot/**'
      # Pilot tests (scoped)
      - 'tests/pilot/**'
      # Pilot policy tests (text neutrality)
      - 'tests/policy/test_pilot_*.py'
      # Pilot integration tests (signal isolation)
      - 'tests/integration/test_*pilot*.py'
      # Pilot scripts (explicit prefix)
      - 'scripts/pilot_*.py'
      # This workflow itself
      - '.github/workflows/pilot-phase-gate.yml'

env:
  # Frozen experiment directories - pilot code must NEVER write here
  FROZEN_EXPERIMENT_DIRS: |
    results/cal_exp_1
    results/cal_exp_2
    results/cal_exp_1_upgrade_1

jobs:
  # ===========================================================================
  # PILOT BOUNDARY GUARD
  # ===========================================================================
  boundary-check:
    name: Pilot Boundary Guard
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify no CAL-EXP harness modifications
        run: |
          echo "=== Pilot Boundary Check: CAL-EXP Harness Protection ==="

          # Frozen CAL-EXP harnesses - MUST NOT be modified by pilot changes
          FROZEN_HARNESSES=(
            "scripts/run_p5_cal_exp1.py"
            "scripts/first_light_cal_exp1_warm_start.py"
            "scripts/first_light_cal_exp1_runtime_stability.py"
            "scripts/first_light_cal_exp2_convergence.py"
            "scripts/first_light_cal_exp3_regime_change.py"
          )

          # Get changed files in this PR/push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          VIOLATIONS=()
          for harness in "${FROZEN_HARNESSES[@]}"; do
            if echo "$CHANGED" | grep -q "^${harness}$"; then
              VIOLATIONS+=("$harness")
            fi
          done

          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo ""
            echo "PILOT BOUNDARY VIOLATION: Frozen CAL-EXP harnesses modified!"
            echo "The following files are FROZEN and must not be changed by pilot code:"
            for v in "${VIOLATIONS[@]}"; do
              echo "  - $v"
            done
            echo ""
            echo "If you need to modify CAL-EXP harnesses, use a separate non-pilot PR."
            exit 1
          fi

          echo "OK: No frozen CAL-EXP harnesses modified."

      - name: Verify no writes to frozen experiment directories
        run: |
          echo "=== Pilot Boundary Check: Experiment Results Protection ==="

          # Check if any pilot code references frozen experiment directories
          PILOT_FILES=$(find pilot/ external_ingest/ adapters/ scripts/pilot_*.py -type f -name "*.py" 2>/dev/null || true)

          if [ -z "$PILOT_FILES" ]; then
            echo "No pilot Python files found (pilot paths may not exist yet)."
            exit 0
          fi

          VIOLATIONS=()
          while IFS= read -r frozen_dir; do
            [ -z "$frozen_dir" ] && continue
            for pf in $PILOT_FILES; do
              if grep -l "$frozen_dir" "$pf" 2>/dev/null; then
                VIOLATIONS+=("$pf references $frozen_dir")
              fi
            done
          done <<< "$FROZEN_EXPERIMENT_DIRS"

          if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            echo ""
            echo "PILOT BOUNDARY VIOLATION: Pilot code references frozen experiment directories!"
            for v in "${VIOLATIONS[@]}"; do
              echo "  - $v"
            done
            echo ""
            echo "Pilot code must use pilot-specific output directories (e.g., results/pilot/)."
            exit 1
          fi

          echo "OK: No references to frozen experiment directories."

  # ===========================================================================
  # PILOT LINT & IMPORT CHECK
  # ===========================================================================
  pilot-lint:
    name: Pilot Code Lint
    runs-on: ubuntu-latest
    needs: boundary-check

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen 2>/dev/null || uv sync || pip install -e .

      - name: Verify pilot imports are valid
        run: |
          echo "=== Pilot Import Check ==="

          PILOT_FILES=$(find pilot/ external_ingest/ adapters/ -name "*.py" -type f 2>/dev/null || true)

          if [ -z "$PILOT_FILES" ]; then
            echo "No pilot Python files found. Skipping import check."
            exit 0
          fi

          FAILURES=()
          for pf in $PILOT_FILES; do
            echo "Checking: $pf"
            if ! python -m py_compile "$pf" 2>/dev/null; then
              FAILURES+=("$pf")
            fi
          done

          if [ ${#FAILURES[@]} -gt 0 ]; then
            echo ""
            echo "PILOT LINT FAILURE: Syntax errors in pilot files:"
            for f in "${FAILURES[@]}"; do
              echo "  - $f"
            done
            exit 1
          fi

          echo "OK: All pilot files have valid Python syntax."

  # ===========================================================================
  # PILOT INVARIANT TESTS (text neutrality + signal isolation)
  # ===========================================================================
  pilot-invariants:
    name: Pilot Invariant Tests
    runs-on: ubuntu-latest
    needs: pilot-lint
    # continue-on-error: false â€” test execution errors MUST fail the job

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen 2>/dev/null || uv sync || pip install -e .

      - name: Run pilot text neutrality tests
        run: |
          echo "=== Pilot Text Neutrality Tests ==="
          echo "Verifies pilot warnings/output use neutral language (no banned alarm words)."
          echo ""
          if [ -f "tests/policy/test_pilot_text_neutrality.py" ]; then
            uv run pytest tests/policy/test_pilot_text_neutrality.py -v --tb=short
          else
            echo "WARNING: tests/policy/test_pilot_text_neutrality.py not found"
            exit 1
          fi

      - name: Run pilot signal isolation tests
        run: |
          echo "=== Pilot Signal Isolation Tests ==="
          echo "Verifies pilot ingestion does not interfere with existing signals."
          echo ""
          if [ -f "tests/integration/test_external_pilot_signal_isolation.py" ]; then
            uv run pytest tests/integration/test_external_pilot_signal_isolation.py -v --tb=short
          else
            echo "WARNING: tests/integration/test_external_pilot_signal_isolation.py not found"
            exit 1
          fi

      - name: Pilot adapter smoke check
        run: |
          echo "=== Pilot Adapter Smoke Check ==="
          echo "Verifies pilot_external_ingest_adapter.py imports cleanly."
          echo ""
          python -c "
          from backend.health.pilot_external_ingest_adapter import (
              PilotIngestSource,
              PilotIngestResult,
              validate_external_log_schema,
              ingest_external_log,
              wrap_for_evidence_pack,
              PILOT_INGEST_SCHEMA_VERSION,
          )
          print(f'Pilot adapter version: {PILOT_INGEST_SCHEMA_VERSION}')
          print(f'Source types: {PilotIngestSource.EXTERNAL_JSON}, {PilotIngestSource.EXTERNAL_JSONL}')
          print(f'Result codes: {PilotIngestResult.SUCCESS}, {PilotIngestResult.SCHEMA_INVALID}')
          print('OK: Pilot adapter imports successfully.')
          "

  # ===========================================================================
  # PILOT TESTS (if they exist)
  # ===========================================================================
  pilot-tests:
    name: Pilot Tests
    runs-on: ubuntu-latest
    needs: pilot-invariants
    # Only run if pilot test directory exists
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --frozen 2>/dev/null || uv sync || pip install -e .

      - name: Run pilot tests
        run: |
          if [ -d "tests/pilot" ]; then
            echo "=== Running Pilot Tests ==="
            uv run pytest tests/pilot/ -v --tb=short || echo "Pilot tests completed with failures (advisory)"
          else
            echo "No tests/pilot directory found. Skipping pilot tests."
          fi

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: Pilot Gate Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [boundary-check, pilot-lint, pilot-invariants, pilot-tests]

    steps:
      - name: Report Status
        run: |
          echo "========================================"
          echo "PILOT PHASE GATE SUMMARY"
          echo "========================================"
          echo ""
          echo "ISOLATION GUARANTEES:"
          echo "  - CAL-EXP harnesses: PROTECTED"
          echo "  - Experiment results: PROTECTED"
          echo "  - Pilot scope: ENFORCED"
          echo ""
          echo "RESULTS:"
          echo "  Boundary Check:    ${{ needs.boundary-check.result }}"
          echo "  Pilot Lint:        ${{ needs.pilot-lint.result }}"
          echo "  Pilot Invariants:  ${{ needs.pilot-invariants.result }}"
          echo "  Pilot Tests:       ${{ needs.pilot-tests.result }}"
          echo ""

          if [ "${{ needs.boundary-check.result }}" = "failure" ]; then
            echo "STATUS: BOUNDARY VIOLATION - pilot code touched frozen paths"
            exit 1
          fi

          if [ "${{ needs.pilot-lint.result }}" = "failure" ]; then
            echo "STATUS: LINT FAILURE - pilot code has syntax errors"
            exit 1
          fi

          if [ "${{ needs.pilot-invariants.result }}" = "failure" ]; then
            echo "STATUS: INVARIANT FAILURE - pilot text neutrality or signal isolation tests failed"
            exit 1
          fi

          echo "STATUS: PILOT GATE PASSED"
          echo "========================================"
