# PHASE II â€” NOT USED IN PHASE I
#
# Budget Health Monitor
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Non-blocking CI workflow that monitors budget enforcement health for Phase II
# uplift experiments. Produces advisory reports without failing CI.
#
# Purpose:
#   - Surface budget health metrics in PR comments and Step Summary
#   - Classify slices as SAFE/TIGHT/STARVED for governance visibility
#   - Does NOT block merges â€” purely informational
#
# Triggers:
#   - On push/PR when U2 experiment results are modified
#   - Manual dispatch for ad-hoc analysis
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Budget Health Monitor

on:
  push:
    paths:
      - 'results/**/*.jsonl'
      - 'experiments/results/**/*.jsonl'
      - 'artifacts/u2/**/*.jsonl'
  pull_request:
    paths:
      - 'results/**/*.jsonl'
      - 'experiments/results/**/*.jsonl'
      - 'artifacts/u2/**/*.jsonl'
  workflow_dispatch:
    inputs:
      log_paths:
        description: 'Glob pattern for log files (default: results/**/*.jsonl)'
        required: false
        default: 'results/**/*.jsonl'

# This workflow is advisory only â€” never block on failure
# Use continue-on-error for all steps
jobs:
  budget-health:
    name: Analyze Budget Health
    runs-on: ubuntu-latest
    # Never fail the workflow â€” purely advisory
    continue-on-error: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Install dependencies
        run: uv sync --frozen
      
      - name: Find log files
        id: find-logs
        run: |
          # Find all JSONL files in results directories
          LOG_PATTERN="${{ github.event.inputs.log_paths || 'results/**/*.jsonl' }}"
          
          # Use find with null delimiter for safety
          LOG_FILES=$(find . -path "./$LOG_PATTERN" -type f 2>/dev/null | head -20 | tr '\n' ' ' || echo "")
          
          if [ -z "$LOG_FILES" ]; then
            echo "No log files found matching pattern: $LOG_PATTERN"
            echo "has_logs=false" >> $GITHUB_OUTPUT
          else
            echo "Found log files: $LOG_FILES"
            echo "has_logs=true" >> $GITHUB_OUTPUT
            echo "log_files=$LOG_FILES" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Budget Health Analysis
        if: steps.find-logs.outputs.has_logs == 'true'
        id: analyze
        continue-on-error: true
        run: |
          mkdir -p artifacts
          
          # Run the summarizer with health JSON and Markdown outputs
          uv run python experiments/summarize_budget_usage.py \
            ${{ steps.find-logs.outputs.log_files }} \
            --health-json artifacts/budget_health.json \
            --markdown-summary artifacts/budget_summary.md \
            2>&1 | tee artifacts/analysis.log
          
          # Check if any slices are STARVED
          if grep -q '"status": "STARVED"' artifacts/budget_health.json 2>/dev/null; then
            echo "starved_found=true" >> $GITHUB_OUTPUT
          else
            echo "starved_found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate Step Summary
        if: steps.find-logs.outputs.has_logs == 'true'
        run: |
          echo "# ðŸ“Š Budget Health Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> PHASE II â€” NOT USED IN PHASE I" >> $GITHUB_STEP_SUMMARY
          echo "> This is an **advisory report** â€” it does not block CI." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/budget_summary.md ]; then
            cat artifacts/budget_summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No budget summary generated." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by budget-health.yml workflow*" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Artifacts
        if: steps.find-logs.outputs.has_logs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: budget-health-report
          path: artifacts/
          retention-days: 30
      
      - name: Advisory Notice (STARVED slices)
        if: steps.analyze.outputs.starved_found == 'true'
        run: |
          echo "::notice title=Budget Health Advisory::Some slices have STARVED budget health. Review cycle_budget_s and taut_timeout_s parameters. This is advisory only."
      
      - name: No Logs Found Notice
        if: steps.find-logs.outputs.has_logs != 'true'
        run: |
          echo "No U2 experiment logs found to analyze." >> $GITHUB_STEP_SUMMARY
          echo "::notice title=Budget Health::No log files found matching the specified pattern. This workflow runs when U2 experiment results are present."

