import json, subprocess, tempfile, os, sys, pathlib, pytest

ROOT = pathlib.Path(__file__).resolve().parents[2]
EXPORTER = ROOT / "backend" / "tools" / "export_fol_ab.py"

def have_exporter():
    return EXPORTER.exists()

def run_exporter(args):
    env = os.environ.copy()
    env.setdefault("NO_NETWORK","true")
    p = subprocess.run([sys.executable, str(EXPORTER), *args], capture_output=True, text=True, env=env)
    return p.returncode, (p.stdout or "") + (p.stderr or "")

@pytest.mark.skipif(not have_exporter(), reason="exporter CLI not present yet")
def test_dry_run_valid_v1_ok():
    with tempfile.NamedTemporaryFile("w+", suffix=".jsonl", delete=False) as f:
        rec = {"system":"fol","mode":"baseline","method":"fol-baseline","seed":"1",
               "inserted_proofs":1,"wall_minutes":0.1,"block_no":1,"merkle":"0"*64}
        f.write(json.dumps(rec)+"\n"); f.flush()
        code, out = run_exporter(["--input", f.name, "--dry-run"])
        assert code == 0, out
        assert "DRY-RUN ok" in out, out

@pytest.mark.skipif(not have_exporter(), reason="exporter CLI not present yet")
def test_dry_run_mixed_schema_nonzero():
    with tempfile.NamedTemporaryFile("w+", suffix=".jsonl", delete=False) as f:
        f.write('{"legacy": true}\n')
        f.write(json.dumps({"system":"fol","mode":"baseline","method":"fol-baseline","seed":"1",
                            "inserted_proofs":1,"wall_minutes":0.1,"block_no":1,"merkle":"0"*64})+"\n")
        f.flush()
        code, out = run_exporter(["--input", f.name, "--dry-run"])
        assert code != 0, out
        assert ("mixed-schema" in out.lower()) or ("mixed schema" in out.lower()) or ("error" in out.lower()), out
