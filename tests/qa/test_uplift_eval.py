"""
Unit tests for uplift_eval.py
Tests determinism, guardrails, and ABSTAIN paths.

Generated by Manus C - Telemetry Architect
"""

import pytest
import json
import csv
import hashlib
import subprocess
import sys
from pathlib import Path
from tempfile import TemporaryDirectory


def run_uplift_eval(cwd: Path) -> tuple:
    """
    Run uplift_eval.py and return (returncode, stdout, stderr).
    """
    # Copy script into temp directory
    script_src = Path('/home/ubuntu/mathledger/scripts/telemetry/uplift_eval.py')
    script_dst = cwd / 'uplift_eval.py'
    import shutil
    shutil.copy(script_src, script_dst)
    
    result = subprocess.run(
        [sys.executable, 'uplift_eval.py'],
        cwd=cwd,
        capture_output=True,
        text=True
    )
    return result.returncode, result.stdout, result.stderr


def create_test_csv(path: Path, rows: list):
    """Create a test CSV file with given rows."""
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, 'w', newline='', encoding='utf-8') as f:
        writer = csv.DictWriter(f, fieldnames=[
            'timestamp', 'proofs', 'cpu_hours', 'successes', 'attempts',
            'verify_ms_p50', 'abstain_rate', 'depth_mean'
        ])
        writer.writeheader()
        writer.writerows(rows)


def test_determinism():
    """Test that same inputs produce same outputs and hashes."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Create test data
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
            {'timestamp': '2025-10-19T01:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
            {'timestamp': '2025-10-19T01:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        # Run twice
        code1, stdout1, stderr1 = run_uplift_eval(tmpdir)
        
        # Read output
        with open(tmpdir / 'artifacts/uplift/uplift.json', 'r') as f:
            output1 = f.read()
        
        # Run again
        code2, stdout2, stderr2 = run_uplift_eval(tmpdir)
        
        with open(tmpdir / 'artifacts/uplift/uplift.json', 'r') as f:
            output2 = f.read()
        
        # Verify determinism (excluding generated_at timestamp)
        data1 = json.loads(output1)
        data2 = json.loads(output2)
        
        # Remove timestamps for comparison
        data1_no_ts = {k: v for k, v in data1.items() if k != 'generated_at'}
        data2_no_ts = {k: v for k, v in data2.items() if k != 'generated_at'}
        
        assert data1_no_ts == data2_no_ts, "Outputs should be deterministic"
        assert code1 == 0 and code2 == 0, "Both runs should succeed"


def test_p_value_formatting():
    """Test that p-values are never formatted as p=0.0."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Create data with very large difference (should give tiny p-value)
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '10', 'cpu_hours': '1.0',
             'successes': '10', 'attempts': '10', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '1000', 'cpu_hours': '1.0',
             'successes': '1000', 'attempts': '1000', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 0, "Should succeed"
        assert 'p=0.0' not in stdout, "Should never print p=0.0"
        assert 'p<' in stdout, "Should use p< notation for small p-values"


def test_abstain_missing_baseline():
    """Test ABSTAIN when baseline.csv is missing."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Only create guided.csv
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 1, "Should exit with error code"
        assert 'ABSTAIN' in stderr, "Should print ABSTAIN"
        assert 'baseline.csv' in stderr, "Should mention missing file"


def test_abstain_missing_guided():
    """Test ABSTAIN when guided.csv is missing."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Only create baseline.csv
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 1, "Should exit with error code"
        assert 'ABSTAIN' in stderr, "Should print ABSTAIN"
        assert 'guided.csv' in stderr, "Should mention missing file"


def test_abstain_schema_mismatch_extra_column():
    """Test ABSTAIN when CSV has extra columns."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Create baseline with extra column
        baseline_path = tmpdir / 'artifacts/wpv5/baseline.csv'
        baseline_path.parent.mkdir(parents=True, exist_ok=True)
        with open(baseline_path, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=[
                'timestamp', 'proofs', 'cpu_hours', 'successes', 'attempts',
                'verify_ms_p50', 'abstain_rate', 'depth_mean', 'extra_column'
            ])
            writer.writeheader()
            writer.writerow({
                'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
                'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
                'abstain_rate': '0.1', 'depth_mean': '2.5', 'extra_column': 'bad'
            })
        
        # Create valid guided
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 1, "Should exit with error code"
        assert 'ABSTAIN' in stderr, "Should print ABSTAIN"
        assert 'extra' in stderr.lower(), "Should mention extra columns"


def test_abstain_schema_mismatch_missing_column():
    """Test ABSTAIN when CSV is missing required columns."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Create baseline missing depth_mean
        baseline_path = tmpdir / 'artifacts/wpv5/baseline.csv'
        baseline_path.parent.mkdir(parents=True, exist_ok=True)
        with open(baseline_path, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=[
                'timestamp', 'proofs', 'cpu_hours', 'successes', 'attempts',
                'verify_ms_p50', 'abstain_rate'
            ])
            writer.writeheader()
            writer.writerow({
                'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
                'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
                'abstain_rate': '0.1'
            })
        
        # Create valid guided
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 1, "Should exit with error code"
        assert 'ABSTAIN' in stderr, "Should print ABSTAIN"
        assert 'missing' in stderr.lower(), "Should mention missing columns"


def test_canonical_json_output():
    """Test that output is RFC8785 canonical JSON."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 0, "Should succeed"
        
        with open(tmpdir / 'artifacts/uplift/uplift.json', 'r') as f:
            content = f.read()
        
        # Verify it's valid JSON
        data = json.loads(content)
        
        # Verify canonical format (no whitespace except newline at end)
        assert ', ' not in content, "Should use compact separators"
        assert ': ' not in content, "Should use compact separators"
        assert content.endswith('\n'), "Should have POSIX newline"
        
        # Verify ASCII-only
        assert content.isascii(), "Should be ASCII-only"


def test_ascii_only_output():
    """Test that all output is ASCII-only."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert stdout.isascii(), "stdout should be ASCII-only"
        assert stderr.isascii(), "stderr should be ASCII-only"
        
        with open(tmpdir / 'artifacts/uplift/uplift.json', 'r') as f:
            content = f.read()
        assert content.isascii(), "JSON output should be ASCII-only"


def test_da_links_null_when_absent():
    """Test that DA links are null when files don't exist."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 0, "Should succeed"
        
        with open(tmpdir / 'artifacts/uplift/uplift.json', 'r') as f:
            data = json.load(f)
        
        assert data['da_links']['r_t'] is None, "r_t should be null"
        assert data['da_links']['u_t'] is None, "u_t should be null"
        assert data['da_links']['H_t'] is None, "H_t should be null"


def test_success_message_format():
    """Test that success message matches expected format."""
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        baseline_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '44', 'cpu_hours': '1.0',
             'successes': '40', 'attempts': '50', 'verify_ms_p50': '100.0',
             'abstain_rate': '0.1', 'depth_mean': '2.5'},
        ]
        guided_rows = [
            {'timestamp': '2025-10-19T00:00:00Z', 'proofs': '132', 'cpu_hours': '1.0',
             'successes': '120', 'attempts': '150', 'verify_ms_p50': '50.0',
             'abstain_rate': '0.05', 'depth_mean': '3.5'},
        ]
        
        create_test_csv(tmpdir / 'artifacts/wpv5/baseline.csv', baseline_rows)
        create_test_csv(tmpdir / 'artifacts/wpv5/guided.csv', guided_rows)
        
        code, stdout, stderr = run_uplift_eval(tmpdir)
        
        assert code == 0, "Should succeed"
        assert '[PASS] UPLIFT:' in stdout, "Should have PASS marker"
        assert 'baseline=' in stdout, "Should show baseline rate"
        assert 'guided=' in stdout, "Should show guided rate"
        assert '/h' in stdout, "Should show per-hour rates"


if __name__ == '__main__':
    pytest.main([__file__, '-v'])

